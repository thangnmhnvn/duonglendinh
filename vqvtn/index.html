<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>V√≤ng quay h·ªçc sinh - Chi·∫øc N√≥n K·ª≥ Di·ªáu</title>
    <link rel="stylesheet" href="style.css">

    <style>
        :root {
            --size: 480px;
            --border: 10px;
        }

        h1{ margin:8px 0 0; font-size:22px; font-weight:800; letter-spacing:.2px;    text-align: center;}
        .wrap{ position:relative; width:var(--size); height:var(--size); margin:22px auto 8px; }
        #wheel{
            width:100%; height:100%; display:block; border-radius:50%;
            box-shadow: 0 12px 30px rgba(0,0,0,.18), inset 0 0 0 var(--border) #111;
            cursor:pointer; background:#fff;
        }
        /* M≈©i t√™n h∆∞·ªõng xu·ªëng */
        .pointer{
            position:absolute; left:50%; top:-14px; transform:translateX(-50%);
            width:0; height:0;
            border-left: 22px solid transparent;
            border-right:22px solid transparent;
            border-top: 44px solid #e11d48; /* ƒë·ªè, h∆∞·ªõng xu·ªëng */
            filter: drop-shadow(0 6px 6px rgba(0,0,0,.25));
            z-index:5;
        }
        .hint{ font-size:14px; opacity:.8; margin:6px 0 0 }
        .result{
            margin-top:10px; font-size:20px; font-weight:800; color:#0ea5e9;
            text-shadow: 0 1px 0 #fff;
        }
        .bar{
            width:min(560px, 92vw); height:10px; border-radius:999px; background:#e5e7eb; overflow:hidden; margin-top:10px;
        }
        .fill{ height:100%; width:0%; background:linear-gradient(90deg,#34d399,#22c55e); transition:width .1s; }
    </style>

    <script>
        window.MathJax = {
            tex: {
                // Cho ph√©p $...$ v√† \(...\) cho c√¥ng th·ª©c n·∫±m trong d√≤ng (inline)
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                // Cho ph√©p $$...$$ v√† \[...\] cho c√¥ng th·ª©c hi·ªÉn th·ªã ri√™ng (display)
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                // T·ªëi ∆∞u h√≥a render b·∫±ng c√°ch ch·ªâ x·ª≠ l√Ω m·ªôt s·ªë class nh·∫•t ƒë·ªãnh (t√πy ch·ªçn)
                ignoreHtmlClass: 'no-mathjax',
                processHtmlClass: 'process-mathjax'
            }
        };
    </script>

    <script id="MathJax-script" async src="mathjax.js"></script>
</head>
<body>

<div id="welcomeScreen">
    <h1 class="title">V√íNG QUAY V√Ä TR·∫ÆC NGHI·ªÜM</h1>
    <button id="startBtn">üöÄ B·∫Øt ƒë·∫ßu ngay</button>
</div>
<div id="man_vongquay" style="display: none">

    <div class="left">
        <h2 id="lopname"></h2>
        <h3>Danh s√°ch ƒë√£ g·ªçi</h3>
        <ul id="studentList"></ul>
    </div>
    <div class="right">
        <button id="to_trochoi" class="btn_r">üéÆ T·ªõi Tr√≤ Ch∆°i</button>
        <button id="reset_games" class="btn_r"> Reset game </button>
        <div id="chon_che_do">
            <label><input type="checkbox" name="che_do" value="G·ªçi t√™n kh√¥ng l·∫∑p l·∫°i" id="che_do_goi_ten" class="chon_chedo">G·ªçi t√™n kh√¥ng l·∫∑p l·∫°i</label><br>
        </div>
    </div>
    <h1>üé° V√íNG QUAY MAY M·∫ÆN</h1>
    <div class="wrap">
        <div class="pointer"></div>
        <canvas id="wheel" width="960" height="960" title="Nh·∫•n & gi·ªØ ƒë·ªÉ l·∫•y l·ª±c, th·∫£ ƒë·ªÉ quay"></canvas>
    </div>
    <div class="bar" aria-hidden="true"><div class="fill" id="chargeFill"></div></div>
    <div class="hint" id="hint">Gi·ªØ chu·ªôt (ho·∫∑c ch·∫°m gi·ªØ) v√†o v√≤ng quay ƒë·ªÉ l·∫•y l·ª±c ‚Ä¢ T·ªëi thi·ªÉu quay 5 gi√¢y</div>
    <div class="result" id="result" style="font-size: 36px"></div>
</div>

<!------------------------------------------------------------- -->


<div id="man_trochoi" style="display:none">
    <div class="right_down">
        <button id="back_vongquay" class="btn_r">V·ªÅ V√≤ng Quay</button>
    </div>
    <div id="gameScreen" >
        <div class="thongtinhocsinh">
            <span id="ten_hocsinh"  class="tths"></span>
        </div >
        <div><img src="trangti.png" alt="trang ti" id="trangti" class="trang_ti">
            <span class="score" id="score">0 </span></div>
        <div class="level-bar">
            <div class="level-track" id="levelTrack"></div>
            <img src="monkey.png" alt="monkey" id="levelMonkey" class="level-monkey">
            <div class="level-label" id="levelLabel">0/0</div>
        </div>
        <!-- ƒê·ªìng h·ªì + g√† ch·∫°y -->
        <div class="timer">
            <span id="timer">0</span>
            <img src="gadungyen.png" alt="chickenTimer" id="chickenTimer" class="timer-chicken">
        </div>

        <!-- G√† ph·∫£n ·ª©ng ·ªü d∆∞·ªõi -->
        <div class="chicken-box"><img src="chicken_stand.png" alt="chicken" id="chickenReaction" class="chicken-reaction"></div>
        <div class="config" style="margin-bottom:0;">
            <label><input type="checkbox" name="random_question" value="1" checked>Tr·ªôn ng·∫´u nhi√™n c√¢u h·ªèi v√† c√¢u tr·∫£ l·ªùi</label><br>
        </div>
        <div class="config" style="margin-top:0;">
            <label>‚è≥ Th·ªùi gian m·ªói c√¢u: <input type="number" id="timeConfig" value="15" min="5"></label>
            <label>üî¢ S·ªë c√¢u h·ªèi: <input type="number" id="countConfig" value="3" min="1" max="10"></label>
        </div>
        <div class="container">

            <div class="question" id="question">Nh·∫•n "B·∫Øt ƒë·∫ßu" ƒë·ªÉ ch∆°i!</div>
            <div class="options" id="options"></div>

            <button class="button-with-icon controls" id="nextBtn" onclick="nextQuestion()">
                <svg
                        class="icon"
                        id="Play"
                        viewBox="0 0 48 48"
                        xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                            class="color000000 svgShape"
                            fill="#ffffff"
                            d="M12 39c-.549 0-1.095-.15-1.578-.447A3.008 3.008 0 0 1 9 36V12c0-1.041.54-2.007 1.422-2.553a3.014 3.014 0 0 1 2.919-.132l24 12a3.003 3.003 0 0 1 0 5.37l-24 12c-.42.21-.885.315-1.341.315z"
                    ></path>
                </svg>
                <span class="text">Play</span>
            </button>

        </div>
    </div>

</div>
<!-- √Çm thanh -->
<audio id="tickSound" src="vongquay.mp3" preload="auto"></audio>
<audio id="winSoundvq" src="chucmung.mp3" preload="auto"></audio>
<audio id="correctSound" src="crrec.mp3" preload="auto"></audio>
<audio id="wrongSound" src="wrong.mp3" preload="auto"></audio>
<audio id="countdownSound" src="demnguoc.mp3" preload="auto"></audio>
<audio id="winSound" src="win.mp3" preload="auto"></audio>
<script src="confetti.browser.min.js"></script>
<script>
    /* ======= C·∫§U H√åNH ======= */


    /* Thay danh s√°ch t√™n h·ªçc sinh v√†o d√¢y*/


    /*K·∫øt th√∫c danh s√°ch*/

    // t·ªëi ƒëa t·ªëc ƒë·ªô khi gi·ªØ (rad/khung h√¨nh ~ 60fps)
    const MAX_ANGULAR_VEL = 0.45;
    const ACCEL_PER_MS = 0.00028;     // tƒÉng t·ªëc khi ƒëang gi·ªØ
    const DECAY = 0.985;              // h·ªá s·ªë gi·∫£m t·ªëc khi th·∫£ (m·ªói khung)
    const MIN_SPIN_MS =   5000;         // t·ªëi thi·ªÉu quay 5 gi√¢y
    /* ======================== */

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const resultEl = document.getElementById('result');
    const hintEl = document.getElementById('hint');
    const chargeFill = document.getElementById('chargeFill');

    const size = canvas.width;              // 960
    const R = size/2;                       // 480
    let rotation = 0;                       // g√≥c hi·ªán t·∫°i (rad)
    let omega = 0;                          // v·∫≠n t·ªëc g√≥c (rad/frame)
    let holding = false;                    // ƒëang gi·ªØ ƒë·ªÉ l·∫•y l·ª±c
    let spinning = false;                   // ƒëang quay (sau khi th·∫£)
    let lastTime = 0;                       // timestamp khung tr∆∞·ªõc
    let holdStart = 0;                      // m·ªëc th·ªùi gian b·∫Øt ƒë·∫ßu gi·ªØ
    let releaseStart = 0;                   // m·ªëc th·∫£ chu·ªôt
    let lastIndexUnderPointer = -1;         // ƒë·ªÉ ph√°t tick khi ƒë·ªïi √¥
    let vt=0;
    let	winner;
    let hocSinhDangChoi = null;
    let diemDangChoi = 0;
    let bangDiem = {};
    /* ========= √ÇM THANH (Web Audio ‚Äì kh√¥ng c·∫ßn file) ========= */
    let audioCtx;
    let temp=true;




    let current = -1, score = 0, timer = 0, timerId = null, answered = false;
    let timePerQuestion = 15, totalQuestions = 3;


    const qEl = document.getElementById("question");
    const optsEl = document.getElementById("options");
    const scoreEl = document.getElementById("score");
    const timerEl = document.getElementById("timer");
    const chickenReactionEl = document.getElementById("chickenReaction");
    const chickenTimerEl = document.getElementById("chickenTimer"); // g√† c·∫°nh ƒë·ªìng h·ªì
    const nextBtn = document.getElementById("nextBtn");
    const winSound = document.getElementById("winSound");
    const correctSound = document.getElementById("correctSound");
    const wrongSound = document.getElementById("wrongSound");
    const countdownSound = document.getElementById("countdownSound");
    //Kh·ªâ leo cot
    const levelMonkey = document.getElementById("levelMonkey");
    const levelLabel = document.getElementById("levelLabel");
    let correctCount = 0; // s·ªë c√¢u ƒë√∫ng


    const startBtn = document.getElementById("startBtn");
    const welcomeScreen = document.getElementById("welcomeScreen");
    const gameScreen = document.getElementById("gameScreen");
    //const lopname="L·ªöP 7A";
    let  lopname ="";
    let  students =[];
    let  studentsbd =[];
    let questions = [];
    let arc=null;
    let questionPool = [];
    let CLASS_KEY="";
    //let questionPool = [];
    // H√†m x√°o tr·ªôn m·∫£ng
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // L·∫•y ng·∫´u nhi√™n c√¢u h·ªèi v√† tr·ªôn opts
    function getRandomQuestions(count) {
        if (questionPool.length < count) {
            questionPool = [...allQuestions];
        }

        let ranQuestion = document.querySelector('[name="random_question"]').checked;
        // X√°o tr·ªôn pool
        if(ranQuestion) shuffleArray(questionPool);

        const selected = questionPool.slice(0, count);
        questionPool.splice(0, count); // lo·∫°i b·ªè c√¢u ƒë√£ l·∫•y

        // Tr·ªôn opts v√† c·∫≠p nh·∫≠t answer cho t·ª´ng c√¢u
        selected.forEach(q => {
            const correctAnswer = q.opts[q.answer]; // l∆∞u ƒë√°p √°n ƒë√∫ng
            if(ranQuestion) shuffleArray(q.opts);                   // tr·ªôn c√°c l·ª±a ch·ªçn
            q.answer = q.opts.indexOf(correctAnswer); // c·∫≠p nh·∫≠t v·ªã tr√≠ ƒë√°p √°n ƒë√∫ng
        });

        return selected;
    }
    const data = {
        "tenlop":"L·ªõp 6E",
        "type":"questions",
        "students":["Nguy\u1ec5n Tr\u01b0\u1eddng An","L\u00ea Nh\u1eadt Anh","Nguy\u1ec5n L\u00ea Ho\u00e0i Anh","V\u0169 Thi\u00ean \u00c2n","Nguy\u1ec5n B\u0103ng B\u0103ng","V\u0169 Qu\u1ef3nh Chi","Nguy\u1ec5n Qu\u1ef3nh Chi","Nguy\u1ec5n Nh\u00e2n Chinh","Nguy\u1ec5n Tr\u1ecdng \u0110\u1ea1t","Nguy\u1ec5n Duy \u0110\u00f4ng","Nguy\u1ec5n Minh \u0110\u1ee9c","L\u00ea Ti\u1ebfn D\u0169ng","Tr\u1ea7n Th\u1ecb Thu H\u00e0","\u0110\u1eb7ng An Khang","V\u0169 T\u1eed Kh\u00e1nh","B\u00f9i \u0110\u00ecnh T\u00f9ng L\u00e2m","Tr\u1ea7n B\u1ea3o L\u00e2m","Nguy\u1ec5n Kh\u00e1nh Linh","Nguy\u1ec5n V\u0169 Minh","Nguy\u1ec5n Tu\u1ec7 Minh","V\u0169 Duy Nam","Ng. Th\u1ecb Kim Ng\u00e2n","Ho\u00e0ng Tr\u1ecdng Ngh\u0129a","Nguy\u1ec5n Th\u1ecb Th\u1ea3o Nguy\u00ean","Nguy\u1ec5n Tu\u1ec7 Nhi","Nguy\u1ec5n Qu\u1ef3nh Ph\u01b0\u01a1ng","Nguy\u1ec5n Nh\u01b0 Qu\u1ef3nh","V\u01b0\u01a1ng B\u0103ng T\u00e2m","Nguy\u1ec5n Minh T\u00f9ng","Nguy\u1ec5n Th\u1ea3o V\u00e2n","Nguy\u1ec5n Nh\u1eadt Vy","Tr\u1ea7n H\u00e0 Vy"],
        "questions":[{"q":"T·ª´ n√†o sau ƒë√¢y l√† t·ª´ l√°y ho√†n to√†n?","opts":["Xanh xao","Xinh x·∫Øn","M·∫∑t m≈©i","ThƒÉm th·∫≥m"],"answer":3},{"q":"Trong c√¢u 'Em l√†m b√†i t·∫≠p v·ªÅ nh√†.', b·ªô ph·∫≠n n√†o l√† ch·ªß ng·ªØ?","opts":["Em","l√†m b√†i t·∫≠p","v·ªÅ nh√†","b√†i t·∫≠p"],"answer":0},{"q":"Bi·ªán ph√°p tu t·ª´ n√†o ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c√¢u 'M·∫∑t tr·ªùi l√† l√≤ng ƒë·ªè qu·∫£ tr·ª©ng kh·ªïng l·ªì'?","opts":["So s√°nh","Nh√¢n h√≥a","·∫®n d·ª•","Ho√°n d·ª•"],"answer":0},{"q":"T·ª´ n√†o l√† t√≠nh t·ª´ ch·ªâ t√≠nh c√°ch?","opts":["C√°i b√†n","Vui v·∫ª","Nh·∫£y","Cao"],"answer":1},{"q":"Th√†nh ph·∫ßn n√†o tr·∫£ l·ªùi cho c√¢u h·ªèi 'Khi n√†o?' trong c√¢u 'H√¥m qua, em ƒë∆∞·ª£c ƒëi·ªÉm 10.'","opts":["Em","ƒë∆∞·ª£c ƒëi·ªÉm 10","H√¥m qua","ƒëi·ªÉm 10"],"answer":2},{"q":"T·ª´ n√†o l√† t·ª´ l√°y b·ªô ph·∫≠n?","opts":["L·∫∑ng l·∫Ω","Xinh x·∫Øn","ChƒÉm ch·ªâ","Lung linh"],"answer":1},{"q":"T·ª´ n√†o l√† ƒë·∫°i t·ª´ nh√¢n x∆∞ng ng√¥i th·ª© nh·∫•t (s·ªë √≠t)?","opts":["B·∫°n","H·ªç","T√¥i","C√°c b·∫°n"],"answer":2},{"q":"Bi·ªán ph√°p tu t·ª´ n√†o ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c√¢u 'Nh·ªØng ng√¥i sao th·ª©c ngo√†i kia'?","opts":["So s√°nh","Nh√¢n h√≥a","·∫®n d·ª•","Ho√°n d·ª•"],"answer":1},{"q":"T·ª´ n√†o l√† t·ª´ ch·ªâ ƒë·∫∑c ƒëi·ªÉm c·ªßa s·ª± v·∫≠t?","opts":["Ng√¥i nh√†","Ch·∫°y nh·∫£y","Xanh bi·∫øc","ƒÇn u·ªëng"],"answer":2},{"q":"Trong c√¢u 'Ch√∫ b·ªô ƒë·ªôi d≈©ng c·∫£m b·∫£o v·ªá T·ªï qu·ªëc.', t·ª´ n√†o l√† danh t·ª´ ch·ªâ ng∆∞·ªùi?","opts":["d≈©ng c·∫£m","b·∫£o v·ªá","Ch√∫ b·ªô ƒë·ªôi","T·ªï qu·ªëc"],"answer":2}]    };

    // N·∫øu c√≥ tenlop + students
    if (data.tenlop && data.students) {
        lopname = data.tenlop || "";
        students = data.students || [];
        studentsbd = [...students];
        arc = (2*Math.PI)/students.length;
        CLASS_KEY = "vongquaytracnghiem"+lopname;

        document.getElementById("lopname").innerText = lopname.toUpperCase();
    }

    // N·∫øu c√≥ c√¢u h·ªèi
    if (data.type === "questions" && data.questions) {
        questionPool = data.questions || [];

    }


    function getArc() {
        return (2*Math.PI)/students.length;
    }


    document.getElementById("to_trochoi").addEventListener("click", function() {
        if (!hocSinhDangChoi) {
            alert("‚ö†Ô∏è H√£y ch·ªçn m·ªôt h·ªçc sinh tr∆∞·ªõc!");
            return;
        }
        document.getElementById("man_vongquay").style.display = "none";
        document.getElementById("man_trochoi").style.display = "block";
        document.getElementById("ten_hocsinh").innerText = "üë§: " + hocSinhDangChoi;

        // Reset ƒëi·ªÉm m·ªói l·∫ßn ch∆°i
        diemDangChoi = 0;
        //document.getElementById("diem").innerText = diemDangChoi;

    });
    document.getElementById("reset_games").addEventListener("click", function() {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën RESET danh s√°ch kh√¥ng?")) {
            localStorage.removeItem(CLASS_KEY); // X√≥a d·ªØ li·ªáu trong storage
            renderStudents();
            students = [...studentsbd]; // studentsbd l√† b·∫£n sao danh s√°ch ban ƒë·∫ßu
            console.log(students);
            drawWheel();
        }

    });
    // N√∫t quay v·ªÅ v√≤ng quay
    document.getElementById("back_vongquay").addEventListener("click", function() {
        // C·ªông ƒëi·ªÉm cho h·ªçc sinh
        if (hocSinhDangChoi) {
            bangDiem[hocSinhDangChoi] = (bangDiem[hocSinhDangChoi] || 0) + diemDangChoi;
            // Hi·ªÉn th·ªã ƒëi·ªÉm ngay trong danh s√°ch
            document.querySelectorAll("#ds_hocsinh li").forEach(li => {
                if (li.getAttribute("data-ten") === hocSinhDangChoi) {
                    li.innerText = hocSinhDangChoi + " - ƒêi·ªÉm: " + bangDiem[hocSinhDangChoi];
                }
            });
            updateScore(hocSinhDangChoi, score);
        }
        resetTroChoi();
        document.getElementById("man_trochoi").style.display = "none";
        document.getElementById("man_vongquay").style.display = "block";
    });
    let checkBox = document.getElementById("che_do_goi_ten");

    // Set tr·∫°ng th√°i: t√≠ch v√†o
    checkBox.checked = true;
    document.getElementById("che_do_goi_ten").addEventListener("change", function() {
        if (this.checked) {
            temp=true;

        } else {
            temp=false;
        }
    });;
    function playTick() {
        //tickSound.currentTime = 0; // tua v·ªÅ ƒë·∫ßu ƒë·ªÉ c√≥ th·ªÉ ph√°t li√™n ti·∫øp
        tickSound.play();
    }

    function playWin() {
        winSoundvq.currentTime = 0;
        winSoundvq.play();
    }
    function stopTick() {
        tickSound.pause();
        tickSound.currentTime = 0;
    }

    function fadeOut(audio, duration = 3000) {
        if (!audio) return;
        let step = audio.volume / (duration / 100); // gi·∫£m m·ªói 100ms
        let fade = setInterval(() => {
            if (audio.volume - step > 0) {
                audio.volume = Math.max(0, audio.volume - step);
            } else {
                audio.pause();
                audio.currentTime = 0;
                audio.volume = 1; // reset l·∫°i volume ƒë·ªÉ l·∫ßn sau ph√°t b√¨nh th∆∞·ªùng
                clearInterval(fade);
            }
        }, 100);
    }
    /* ========================================================= */

    /* V·∫Ω v√≤ng quay */
    function drawWheel() {
        ctx.clearRect(0,0,size,size);
        // n·ªÅn vi·ªÅn trong
        ctx.save();
        ctx.translate(R, R);
        ctx.rotate(rotation);
        if(temp==true){
            arc=getArc();
        }
        for (let i=0;i<students.length;i++){
            const start = i*arc;
            const end = start + arc;
            // m√†u r·ª±c r·ª° theo HSL
            const hue = Math.round(i * (360/students.length));
            ctx.beginPath();
            ctx.moveTo(0,0);
            ctx.arc(0,0,R-8, start, end);
            ctx.closePath();
            ctx.fillStyle = `hsl(${hue} 85% 55%)`;
            ctx.fill();

            // ƒë∆∞·ªùng ph√¢n c√°ch
            ctx.strokeStyle = 'rgba(255,255,255,.6)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0,0,R-8,start,end);
            ctx.stroke();

            // label
            ctx.save();
            ctx.rotate(start + arc/2);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 24px system-ui, Arial';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = 'rgba(0,0,0,.35)';
            ctx.shadowBlur = 4;
            ctx.fillText(students[i], R-26, 0);
            ctx.restore();
        }
        // n·∫Øp trung t√¢m
        ctx.beginPath();
        ctx.arc(0,0,38,0,2*Math.PI);
        ctx.fillStyle = '#111';
        ctx.fill();
        ctx.beginPath();
        ctx.arc(0,0,28,0,2*Math.PI);
        ctx.fillStyle = '#fff';
        ctx.fill();
        ctx.restore();
    }

    /* L·∫•y index t·∫°i h∆∞·ªõng m≈©i t√™n (m≈©i t√™n ·ªü TOP, ch·ªâ xu·ªëng) */
    function indexUnderPointer(rot){
        if(temp==true){
            arc=getArc();
        }
        // c√¥ng th·ª©c t∆∞∆°ng th√≠ch v·ªõi m≈©i t√™n top: +90deg
        const degrees = rot * 180/Math.PI + 90;
        const arcd = arc * 180/Math.PI;
        let idx = Math.floor((360 - ((degrees % 360)+360)%360) / arcd);
        idx = (idx % students.length + students.length) % students.length;
        return idx;
    }

    /* V√≤ng l·∫∑p khung h√¨nh */
    function tick(ts){
        if (!lastTime) lastTime = ts;
        const dt = Math.min(32, ts - lastTime); // ms, clamp ƒë·ªÉ ·ªïn ƒë·ªãnh
        lastTime = ts;

        // n·∫øu ƒëang gi·ªØ: tƒÉng t·ªëc theo th·ªùi gian gi·ªØ
        if (holding){
            omega += ACCEL_PER_MS * dt;
            if (omega > MAX_ANGULAR_VEL) omega = MAX_ANGULAR_VEL;
        }else if (spinning){
            // gi·∫£m t·ªëc
            omega *= DECAY;
            // ƒë·∫£m b·∫£o quay t·ªëi thi·ªÉu MIN_SPIN_MS
            const elapsedSinceRelease = performance.now() - releaseStart;
            const minReached = elapsedSinceRelease >= MIN_SPIN_MS;
            const belowThreshold = omega < 0.0022;
            if (minReached && belowThreshold){
                omega = 0;
                spinning = false;
                // t√≠nh k·∫øt qu·∫£
                const idx = indexUnderPointer(rotation);
                winner = students[idx];

                hintEl.textContent = 'Nh·∫•n & gi·ªØ ƒë·ªÉ l·∫•y l·ª±c, th·∫£ ƒë·ªÉ quay';
                upper = `üéâ Ch√∫c m·ª´ng: ${winner}!`;
                upper1 = upper.toUpperCase();
                resultEl.textContent = upper1;
                fadeOut(tickSound, 2000);
                playWin();
                vt=idx;
                hocSinhDangChoi=students[idx];

// th√™m h·ªçc sinh v√†o c·ªôt tr√°i

                addStudent(hocSinhDangChoi);
                //const ul = document.getElementById("studentList");
                //const li = document.createElement("li");
                //  li.textContent = winner;
                // ul.appendChild(li);
            }
        }

        // c·∫≠p nh·∫≠t g√≥c
        if (omega !== 0){
            rotation = (rotation + omega) % (2*Math.PI);
        }

        // tick sound khi ƒë·ªïi √¥
        const currIdx = indexUnderPointer(rotation);
        if (currIdx !== lastIndexUnderPointer){
            // ph√°t tick khi ƒëang quay ƒë·ªß nhanh
            if (omega > 0.03) playTick();
            lastIndexUnderPointer = currIdx;
        }

        drawWheel();
        requestAnimationFrame(tick);
    }

    /* S·ª± ki·ªán t∆∞∆°ng t√°c */
    function onHoldStart(e){
        students.splice(vt, 1);
        e.preventDefault();
        //ensureAudioCtx();
        if (spinning) return;
        holding = true;
        holdStart = performance.now();
        resultEl.textContent = '';
        hintEl.textContent = 'ƒêang l·∫•y l·ª±c‚Ä¶ th·∫£ ra ƒë·ªÉ quay!';
        // MIN_SPIN_MS=  (rand.nextInt(12 - 8 + 1) + 8)*1000;
        //    MIN_SPIN_MS = (Math.floor(Math.random() * (12 - 8 + 1)) + 8) * 1000;
    }
    function onHoldEnd(e){
        e && e.preventDefault();
        if (!holding) return;
        holding = false;
        spinning = true;
        releaseStart = performance.now();
        hintEl.textContent = 'ƒêang quay‚Ä¶';
    }

    // Chu·ªôt
    canvas.addEventListener('mousedown', onHoldStart);
    window.addEventListener('mouseup', onHoldEnd);
    canvas.addEventListener('mouseleave', (e)=> holding && onHoldEnd(e));
    // C·∫£m ·ª©ng
    canvas.addEventListener('touchstart', onHoldStart, {passive:false});
    window.addEventListener('touchend', onHoldEnd, {passive:false});

    // Thanh hi·ªÉn th·ªã ‚Äúl·∫•y l·ª±c‚Äù
    setInterval(()=>{
        const pct = Math.min(100, Math.round((omega / MAX_ANGULAR_VEL)*100));
        chargeFill.style.width = (holding ? pct : 0) + '%';
    }, 60);





    /* TR√í CH∆†I*==========================================*/

    startBtn.addEventListener("click", () => {
        /* Kh·ªüi ƒë·ªông */
        drawWheel();
        requestAnimationFrame(tick);
        getStudents();
        renderStudents();
        // th√™m class fadeOut ƒë·ªÉ ch·∫°y animation
        welcomeScreen.classList.add("fadeOut");

        // sau khi h·∫øt hi·ªáu ·ª©ng (1s) th√¨ ·∫©n h·∫≥n v√† hi·ªán game
        setTimeout(() => {
            welcomeScreen.style.display = "none";
            man_vongquay.style.display = "block";
        }, 1000); // 1000ms = 1s tr√πng v·ªõi transition
    });

    // C·∫≠p nh·∫≠t thanh level

    function updateLevel() {
        let total = questions.length;
        let progress = correctCount / total;
        let barHeight = 500; // chi·ªÅu cao thanh level
        let monkeyPos = progress * (barHeight - 60); // 60 l√† chi·ªÅu cao con kh·ªâ

        // üö© Khi b·∫Øt ƒë·∫ßu di chuy·ªÉn -> kh·ªâ leo
        levelMonkey.src = "monkeyclimb.gif";
        levelMonkey.style.bottom = monkeyPos + "px";
        levelLabel.textContent = correctCount + "/" + total;

        // üö© Sau khi leo xong -> ƒë·ªïi sang idle ho·∫∑c happy
        setTimeout(() => {
            if (correctCount === total) {
                levelMonkey.src = "monkeyhappy.gif"; // leo h·∫øt -> vui
            } else {
                levelMonkey.src = "monkeyidle.gif"; // ch∆∞a h·∫øt -> ƒë·ª©ng y√™n
            }
        }, 800); // ch·ªù animation leo xong
    }


    function playWin(){
        winSound.currentTime = 0;
        winSound.play();
    }

    function launchConfetti(){
        // b·∫Øn confetti nhi·ªÅu l·∫ßn cho ƒë·∫πp
        let duration = 6 * 1000; // 3 gi√¢y
        let end = Date.now() + duration;

        (function frame() {
            confetti({
                particleCount: 6,
                angle: 60,
                spread: 55,
                origin: { x: 0 }
            });
            confetti({
                particleCount: 6,
                angle: 120,
                spread: 55,
                origin: { x: 1 }
            });

            if (Date.now() < end) {
                requestAnimationFrame(frame);
            }
        }());
    }


    function nextQuestion(){
        clearInterval(timerId);
        stopCountdownSound();
        if(current === -1){
            timePerQuestion = parseInt(document.getElementById("timeConfig").value) || 15;
            totalQuestions = parseInt(document.getElementById("countConfig").value) || 3;



            questions = getRandomQuestions(totalQuestions);

            correctCount = 0; // reset
            updateLevel();    // reset thanh level
            levelMonkey.src = "monkeyidle.gif";


            score = 0;
            scoreEl.firstChild.textContent = score + " ";
            current = 0;
            showQuestion();
            return;
        }
        current++;

        if(current >= questions.length){
            qEl.textContent = "üéâ Ho√†n th√†nh! T·ªïng ƒëi·ªÉm: " + score;
            optsEl.innerHTML = "";
            nextBtn.textContent = "Ch∆°i l·∫°i";

            current = -1;
            return;
        }
        showQuestion();
    }

    function showQuestion(){
        timer = timePerQuestion;
        timerEl.textContent = timer;
        answered = false;
        let q = questions[current];
        qEl.textContent = `C√¢u ${current+1}/${questions.length}: ${q.q}`;
        optsEl.innerHTML = "";
        q.opts.forEach((opt,i)=>{
            const btn=document.createElement("button");
            btn.textContent = String.fromCharCode(65+i)+". "+opt;
            btn.onclick=()=>selectAnswer(i,q.answer,btn);
            optsEl.appendChild(btn);
        });
        nextBtn.style.display="none";

        // üö© Khi b·∫Øt ƒë·∫ßu c√¢u h·ªèi -> g√† ch·∫°y
        chickenTimerEl.src = "ga_chay.gif";

        timerId=setInterval(()=>{
            timer--;
            timerEl.textContent=timer;
            if(timer===10){ playCountdownSound(); }
            if(timer<=6 && timer>0){
                timerEl.classList.add("pulse");
                setTimeout(()=>timerEl.classList.remove("pulse"),500);
            }
            if(timer<=0){
                clearInterval(timerId);
                // üö© H·∫øt gi·ªù -> g√† ƒë·ª©ng y√™n
                chickenTimerEl.src = "gadungyen.png";
                chickenReactionEl.src = "chicken_buon.png";
                setTimeout(()=>{ chickenReactionEl.src = "chicken_stand.png"; },3000);
                setTimeout(()=>{ stopCountdownSound(); },3000);
                disableOptions();
                nextBtn.style.display="inline-block";
                nextBtn.textContent="Ti·∫øp t·ª•c";
            }
        },1000);

        if (typeof MathJax !== 'undefined') {
            const questionContainer = document.getElementById('question');
            if (questionContainer) MathJax.typesetPromise([questionContainer]);
            const optionsContainer = document.getElementById('options');
            if (optionsContainer) MathJax.typesetPromise([optionsContainer]);
        }
    }

    function selectAnswer(idx,correct,btn){
        if(answered) return;
        answered = true;
        clearInterval(timerId);
        stopCountdownSound();

        // üö© Khi ch·ªçn ƒë√°p √°n -> g√† ƒë·ª©ng y√™n
        chickenTimerEl.src = "gadungyen.png";

        const buttons=optsEl.querySelectorAll("button");
        buttons.forEach((b,i)=>{
            b.disabled=true;
            if(i===correct) b.classList.add("correct");
            if(i===idx && idx!==correct) b.classList.add("wrong");
        });
        if(idx===correct){
            score+=10;
            scoreEl.firstChild.textContent = score + " ";
            playCorrect();
            showChicken("happy");

            correctCount++;
            updateLevel();
            updateLevel();

            if(score === questions.length * 10){
                playWin();
                launchConfetti();
                playWin();
            }
        } else {
            playWrong();
            showChicken("angry");
        }
        setTimeout(()=>{
            nextBtn.style.display="inline-block";
            nextBtn.textContent = (current >= questions.length-1) ? "K·∫øt th√∫c" : "Ti·∫øp t·ª•c";
        },800);
    }

    function disableOptions(){
        const buttons=optsEl.querySelectorAll("button");
        buttons.forEach(b=>{
            b.disabled=true;
            b.classList.add("disabled");
        });
    }

    function showChicken(state){
        if(state==="happy"){ chickenReactionEl.src = "chicken_happy.gif"; }
        else if(state==="angry"){ chickenReactionEl.src = "chicken_angry.gif"; }
        setTimeout(()=>{ chickenReactionEl.src = "chicken_stand.png"; },3000);
    }

    function playCorrect(){ correctSound.currentTime=0; correctSound.play(); }
    function playWrong(){ wrongSound.currentTime=0; wrongSound.play(); }
    function playCountdownSound(){ countdownSound.currentTime=0; countdownSound.play(); }
    function stopCountdownSound(){ countdownSound.pause(); countdownSound.currentTime=0; }


    // L·∫•y danh s√°ch t·ª´ localStorage
    function getStudents() {
        let data = localStorage.getItem(CLASS_KEY);
        return data ? JSON.parse(data) : [];
    }

    // L∆∞u danh s√°ch v√†o localStorage
    function saveStudents(students) {
        localStorage.setItem(CLASS_KEY, JSON.stringify(students));
    }

    // Hi·ªÉn th·ªã danh s√°ch ra UI
    function renderStudents() {
        let ul = document.getElementById("studentList");
        let students = getStudents();
        ul.innerHTML = "";
        students.forEach(st => {
            let li = document.createElement("li");
            li.textContent = `${st.name} - ${st.score} ƒëi·ªÉm`;
            ul.appendChild(li);
        });
    }

    // ---- S·ª∞ KI·ªÜN ·ªû V√íNG QUAY ----
    // Khi quay tr√∫ng 1 h·ªçc sinh -> th√™m v√†o danh s√°ch n·∫øu ch∆∞a c√≥
    function addStudent(name) {
        let students = getStudents();
        let exist = students.find(s => s.name === name);
        if (!exist) {
            students.push({ name: name, score: 0 });
            saveStudents(students);
            renderStudents();
        }
    }

    // ---- S·ª∞ KI·ªÜN TRONG TR√í CH∆†I ----
    // Khi h·ªçc sinh ch∆°i xong -> c·∫≠p nh·∫≠t ƒëi·ªÉm
    function updateScore(name, score) {
        let students = getStudents();
        let st = students.find(s => s.name === name);
        if (st) {
            st.score += score; // c·ªông th√™m ƒëi·ªÉm
            saveStudents(students);
            renderStudents();
        }
    }
    function resetTroChoi() {
        clearInterval(timerId);
        stopCountdownSound();

        // Reset bi·∫øn game
        score = 0;
        current = -1;
        questions = [];
        correctCount = 0;

        // Reset giao di·ªán
        scoreEl.firstChild.textContent = "0 ";
        qEl.textContent = "Nh·∫•n \"B·∫Øt ƒë·∫ßu\" ƒë·ªÉ ch∆°i!";
        optsEl.innerHTML = "";
        nextBtn.style.display = "inline-block";
        nextBtn.textContent = "Play";

        // Reset level
        levelMonkey.src = "monkeyidle.gif";
        levelMonkey.style.bottom = "0px";
        levelLabel.textContent = "0/0";

        // Reset g√† & ƒë·ªìng h·ªì
        timerEl.textContent = "0";
        chickenTimerEl.src = "gadungyen.png";
        chickenReactionEl.src = "chicken_stand.png";

        // Reset √¢m thanh
        winSound.pause();
        winSound.currentTime = 0;
        correctSound.pause();
        wrongSound.pause();
        countdownSound.pause();
        countdownSound.currentTime = 0;
    }

</script>
</body>
</html>
