<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>üê• ƒêua V·ªãt M∆∞·ª£t M√† üèÅ</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: url("songnuoc.gif") no-repeat center center;
  background-size: cover;
  margin: 0;
  overflow: hidden;
  text-align: center;
  
  
}
h1 { color: white; text-shadow:2px 2px 5px #000; margin-top:10px; }

#controls { 
  position: fixed;
  top: 0px;
  right: 0px;
  margin:0px;
  z-index: 900;
}



#pond-container {
  overflow:hidden;
  width:100vw;
  height:100vh;
  border-top:6px solid white;
  border-bottom:6px solid #004080;
  position:relative;
}



#pond {
  position: absolute;
  top: 200px; /* n·∫±m d∆∞·ªõi b·ªù tr√™n */
  left: 0;
  width: 13000px;
  height: calc(100% - 200px); /* ph·∫ßn n∆∞·ªõc c√≤n l·∫°i */
  transition: transform 0.1s linear;
	  z-index: 11; /* ‚Üê th√™m d√≤ng n√†y */
}

.duck { position:absolute; left:0; width:170px; height:170px }
.duck img { width:170px; height:170px; transform: scaleX(1)}
.name { 
	color:black; font-weight:bold; 
	font-size:14px; position:absolute; 
	top:-3px; 
	left:0px; 
	transform:translateX(-50%); }

#countdown { font-size:160px; color:white; text-shadow:2px 2px 5px black; position:absolute; top:50%; width:100%; display:none; z-index:4; }
#raceTimer { position: fixed; top:210px; right:10px; font-size:60px; color:black; text-shadow:1px 1px 3px black; z-index:5; 
	background: url("thoigian.png") no-repeat; background-size: 100% 100%;
	padding: 16px;;}
#result {
  position: absolute;         /* ƒë·ªÉ transform translate(-50%, -50%) ho·∫°t ƒë·ªông */
  bottom: 10px;                   /* canh gi·ªØa theo chi·ªÅu d·ªçc */
  left: 50%;                  /* canh gi·ªØa theo chi·ªÅu ngang */
  transform: translate(-50%, -50%);
  font-size: 60px;
  color: black;
  text-shadow: 1px 1px 3px black;
  margin-top: 10px;           /* c√≥ th·ªÉ b·ªè n·∫øu d√πng transform ƒë√£ canh gi·ªØa */
  z-index: 12;                /* n·ªïi tr√™n c√°c ph·∫ßn t·ª≠ kh√°c */
  text-align: center;          /* cƒÉn gi·ªØa n·ªôi dung text */
  pointer-events: none;        /* tr√°nh che m·∫•t click n·∫øu c·∫ßn */
	background: gold;
  background: url("bangten.png") no-repeat;
	background-size: 100% 100%;
	padding-top: 6px;
	padding-bottom: 6px;
	padding-left: 16px;
	padding-right: 16px;
  max-width: 80vw;
}

.bubble { position:absolute; width:10px; height:10px; background:rgba(255,255,255,0.7); border-radius:50%; animation:bubbleUp 2s linear forwards; z-index:1; }
.splash { position:absolute; width:15px; height:15px; border-radius:50%; background:rgba(255,255,255,0.8); animation:splashUp 0.6s ease-out forwards; }
.confetti { position:absolute; width:8px; height:8px; border-radius:2px; animation:confettiFall 1s linear forwards; }
.water-ring { position: absolute; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.6); border-radius: 50%; opacity: 1; animation: ringExpand 1.5s ease-out forwards; pointer-events: none; z-index: 1; }

@keyframes bubbleUp { 0% { transform:translateY(0); opacity:1; } 100% { transform:translateY(-80px); opacity:0; } }
@keyframes splashUp { 0%{ transform:scale(1) translateY(0); opacity:1; } 100%{ transform:scale(2) translateY(-40px); opacity:0; } }
@keyframes confettiFall { 0%{ opacity:1; transform:translateY(0) rotate(0deg);} 100%{opacity:0; transform:translateY(-80px) rotate(360deg);} }
@keyframes ringExpand { 0% { transform: scale(1); opacity: 0.9; } 100% { transform: scale(6); opacity: 0; } }

.winner-glow { box-shadow: 0 0 30px 10px gold; border-radius: 50%; animation: glowRotate 2s linear infinite; }

/* B·ªú TR√äN */
#bank {
  position: absolute;
  top: 0;
  left: -1000px;
  width: 13000px;
  height: 180px; /* Chi·ªÅu cao b·ªù */
   background: url("boco.jpg") repeat-x center bottom;
  z-index: 5;
}

/* C√ÇY */
.tree {
  position: absolute;
  bottom: 0; /* g·ªëc c√¢y ch·∫°m m·∫∑t b·ªù */
  background-repeat: no-repeat;
  background-position: center bottom;
  background-size: contain;
  pointer-events: none;
  z-index: 6;
}
.start-line {
  position: absolute;
  top: 180px;            /* v·ªã tr√≠ b·∫Øt ƒë·∫ßu t·ª´ m√©p tr√™n */
  width: 100px;           /* ƒë·ªô r·ªông v·∫°ch */
	left: 100px;
  height: calc(100% - 180px); /* ch·∫°y d·ªçc ph·∫ßn s√¥ng */
  background: url("vachxuatphat.jpg") repeat-y center top;
  z-index: 1;
}
.bo {
  position: absolute;
  top: 160px;            /* v·ªã tr√≠ b·∫Øt ƒë·∫ßu t·ª´ m√©p tr√™n */
  left: -1000px;           /* c√°ch b·ªù tr√°i 100px */
  width: 13000px;           /* ƒë·ªô r·ªông v·∫°ch */
  height: 50px; /* ch·∫°y d·ªçc ph·∫ßn s√¥ng */
  background: url("bo.png") repeat-x center bottom;
  z-index: 8;
}
.xuatphat {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 600px; /* k√≠ch th∆∞·ªõc ·∫£nh PNG */
  height: 400px;
  background: url("xuatphat.png") no-repeat center center;
  background-size: contain;
  transform: translate(-50%, -50%); /* cƒÉn gi·ªØa tuy·ªát ƒë·ªëi */
  z-index: 10; /* n·∫±m tr√™n c√πng */
  transition: opacity 0.8s ease-out;
}
.vedich {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 600px; /* k√≠ch th∆∞·ªõc ·∫£nh PNG */
  height: 400px;
  background: url("vedich.png") no-repeat center center;
  background-size: contain;
  transform: translate(-50%, -50%); /* cƒÉn gi·ªØa tuy·ªát ƒë·ªëi */
  z-index: 10; /* n·∫±m tr√™n c√πng */
  transition: opacity 0.8s ease-out;
}
	
.hidden {
  opacity: 0;
  pointer-events: none;
}	
	

	


.menu-container {
  
  transform: translate(-50%, -50%);  /* ƒë∆∞a ra ch√≠nh gi·ªØa m√†n h√¨nh */	
  background: url("menu1.png") no-repeat;	
  width: 1200px;
  padding-bottom: 65px;
   padding-left: 65px;
	padding-right: 65px;
  background-size: 100% 100%;
	 flex-direction: row; /* Hai c·ªôt ngang */	
  display: flex;
  max-height: 90vh;	
 transform: scale(0.9);
  transition: transform 0.3s ease;	
  z-index: 1000;
}
.winner-menu {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 1000;	
}

.winner-menu.show {
  opacity: 1;
  pointer-events: all;
}
.winner-menu.show .menu-container {
  transform: scale(1);
}

.close-btn {
  margin-top: 10px;
  background: #ff4d4d;
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
}

.clear-btn {
  background: #ff9800;
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  margin-right: 8px;
}
	.buton_dk{
		position: fixed;
		bottom:10px;
		right: 10px;
	}
#winnerList {
  max-height: 300px; /* chi·ªÅu cao t·ªëi ƒëa */
  overflow-y: auto;  /* cu·ªôn d·ªçc khi v∆∞·ª£t qu√° */
  padding-right: 5px; /* tr√°nh b·ªã che n·ªôi dung b·ªüi scrollbar */
}
.danhsach h3, .setup h3 {
  margin-top: 0;
  border-bottom: 2px solid #0078ff;
  padding-bottom: 6px;
  color: #0078ff;
  font-size: 20px;	
}	
	
 .option {
    font-size: 20px;
    margin: 10px 0;
	 text-align: left; /* üëà CƒÉn to√†n b·ªô nh√≥m v·ªÅ b√™n tr√°i */ 
  }	
	
	input{
		font-size: 20px !important;
		 width: 20px;
    height: 20px;
    accent-color: #0078ff; /* M√†u xanh cho radio */
    cursor: pointer;
	}	
/* üåü Chia layout th√†nh 2 c·ªôt */


/* M·ªói c·ªôt chi·∫øm 50% */
.danhsach {
  flex: 1;
  
  padding-top: 100px;
   padding-left: 60px;
	padding-right: 10px;
	padding-bottom: 40px;
	
}
 .setup {
  flex: 1;
  
  padding-top: 90px;
   padding-left: 10px;
	padding-right: 50px;
	padding-bottom: 40px;
	
}	

/* Ti√™u ƒë·ªÅ */
.danhsach h3, .setup h3 {
  margin-top: 0;
  border-bottom: 2px solid #0078ff;
  padding-bottom: 6px;
  color: #0078ff;
}

/* Danh s√°ch ng∆∞·ªùi th·∫Øng */
#winnerList {
  margin-top: 10px;
  min-height: 100px;
}

/* C√°c option */
.option {
  margin: 8px 0;
  font-size: 18px;
}

/* N√∫t */
.clear-btn, .close-btn {
  background: #0078ff;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  margin-right: 5px;
  transition: 0.2s;
}

.clear-btn:hover, .close-btn:hover {
  background: #005fcc;
}
.question-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.qbox {
  background: white;
  padding: 20px;
  border-radius: 12px;
  max-width: 500px;
  text-align: left;
  color: black;
}
.qbox .highlight {
  color: #0077ff;
  font-weight: bold;
}
#questionArea h3{
		font-size: 28px !important;
	}
#questionArea button{
		font-size: 28px !important;
	   border-radius: 6px;
	}	
	#questionArea{
		
		z-index: 900;
	}		
.traloicauhoi {
    display: flex;
    justify-content: center;
    align-items: center;
	position: absolute;
	top: 50%;
	right: 10px;
	z-index: 2000;
}
.traloicauhoi span{
	color: aliceblue!important;
	  
}
button#traloi {
    padding: 20px 40px;
    font-size: 24px;
    color: #fff;
    border: none;
    border-radius: 12px;
    box-shadow: 0 8px 15px rgba(0,0,0,0.3);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
	    display: none; /* ·∫©n ho√†n to√†n kh·ªèi m√†n h√¨nh */

}
button:hover {
    transform: scale(1.1);
    box-shadow: 0 12px 20px rgba(0,0,0,0.4);
}
#opcauhoi{
		display: none;
}
	#questionCountdown{
		font-size: 36px;
		font-weight: bold;
	}
	
.btn-overlay {
  position: relative;
  border: none;
  padding: 0px !important;
  background: none;
  background-size: contain;	
  cursor: pointer;
}
.btn-overlay img {
  width: 160px;
  height: 50px;	
}
.btn-overlay span {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 18px;
}
.btn-overlay:hover span{
 
  color: greenyellow;
 
}
button {padding:6px; font-size:18px; background:#ffdd00; border:none; cursor:pointer; transition:0.3s; }
button:hover { background:#ffcc00; }
	.setup{
		 font-size: 20px;
    margin: 10px 0;
	 text-align: left; /* üëà CƒÉn to√†n b·ªô nh√≥m v·ªÅ b√™n tr√°i */ 
	}	
button {padding:6px; font-size:18px; background:#ffdd00; border:none; cursor:pointer; transition:0.3s; }
button:hover { background:#ffcc00; border-radius: 10px;}	
	.btn_boqua{
		background-color: red;
		color: white !important;
	}

	#closeMenu{
		position: absolute;
		top:80px;
		right: 100px;
	}
	

	
.menu {
  position: fixed;
  top: 0;
  right: 0;
  background:url(button_menu.png) no-repeat center;
  color: white;
  display: flex;
  align-items: center;
  gap: 10px;
  padding:6px;
  background-size: 100% 100%;	
  border-bottom-left-radius: 10px;
  z-index: 100;
  width: auto;              /* ‚úÖ Co gi√£n t·ª± ƒë·ªông */
  max-width: 100vw;         /* Kh√¥ng tr√†n m√†n h√¨nh */
}

#lopname {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
  white-space: nowrap;
}
	
</style>
</head>
<body>

<div id="controls">
   <div id="raceTimer"></div>
  <div class="buton_dk">	
  <button id="setupBtn" class="btn-overlay"><img src="button-bg.png" alt=""><span>T·∫°o ƒë·ªôi ƒëua</span></button>
  <button id="startBtn" class="btn-overlay" disabled><img src="button-bg.png" alt=""><span>B·∫Øt ƒë·∫ßu</span></button>
</div>
 <div class="menu">	
  	<h2 id="lopname"></h2>  
   <button id="menuBtn" class="menu-btn">üèÖMenu</button>
</div>
<div id="winnerMenu" class="winner-menu hidden">
  <div class="menu-container">
    <!-- C·ªôt 1: Danh s√°ch -->
    <div class="danhsach">	
      <h3>üèÜ H·ªçc sinh ƒë√£ chi·∫øn th·∫Øng</h3>
      <div id="winnerList"></div>
	   <div id="soluonghs"></div>
	   	
	<div id="musicControl" style="
  display: flex;
  align-items: center;
  gap: 10px;
    padding: 6px;
  border-radius: 10px;
  width: fit-content;
">
  <button id="toggleMusic">üîä B·∫≠t nh·∫°c</button>
  
  <label style="display: flex; align-items: center; gap: 5px;">
    √Çm l∆∞·ª£ng:
    <input type="range" id="volumeSlider"
           min="0" max="1" step="0.01" value="0.5"
           style="width: 200px;">
  </label>
</div>
		
	  <div style="margin-top:10px;">
		<button id="resetGame" class="btn-overlay"><img src="button_tl.png" alt=""><span>üîÑ Reset Game</span></button>  
		<button id="closeMenu" class="btn-overlay"><img src="button_tl.png" alt=""><span>‚ùå</span></button>    
      </div>  	
    </div>
	

    <!-- C·ªôt 2: C·∫•u h√¨nh -->
    <div class="setup">	
      <h3>üéØ C·∫•u h√¨nh</h3>

      <label style="display:block; margin-top:10px;">
        <input type="checkbox" id="excludeWinners" checked> G·ªçi t√™n kh√¥ng l·∫∑p l·∫°i 
      </label>

      <label>
        ‚è±Ô∏è Th·ªùi gian ƒëua:
        <input type="number" id="thoigiandua" value="10" min="5" max="30" style="width:60px;"> gi√¢y
      </label>
	   <label style="display:block; margin-top:10px;">
        <input type="checkbox" id="hoatanh"> Ho·∫°t ·∫£nh cao
      </label>	

      <h3 style="margin-top:15px;">üéØ Ch·ªçn lo·∫°i cu·ªôc ƒëua:</h3>
      
      <div class="option">
        <label><input type="radio" name="race" value="duck" checked> ü¶Ü ƒêua v·ªãt</label>
      </div>
	  <div class="option">
        <label><input type="radio" name="race" value="boat"> üö£‚Äç‚ôÇÔ∏è ƒêua thuy·ªÅn</label>
      </div>	
	  <div class="option">
        <label><input type="radio" name="race" value="bird" > ü¶Ü ƒêua chim c√°nh c·ª•t</label>
      </div>
	  <div class="option">
        <label><input type="radio" name="race" value="dongvat" > ü¶Ü ƒêua ƒë·ªông v·∫≠t</label>
      </div>
        <h3>üß† C√¢u h·ªèi sau khi th·∫Øng</h3>
        <label><input type="checkbox" id="hstraloicauhoi">Cho h·ªçc sinh tr·∫£ l·ªùi c√¢u h·ªèi</label><br>
        <div id="opcauhoi">
            <label id="dangcauhoi"></label><br>
            <label><input type="checkbox" id="chkLoai"> Lo·∫°i h·ªçc sinh n·∫øu tr·∫£ l·ªùi sai</label><br>
            <label>S·ªë c√¢u h·ªèi ƒë∆∞·ª£c tr·∫£ l·ªùi: <input type="number" id="numQ" value="3" min="1" max="20" style="width:50px"></label> <br>   <label><input type="checkbox" id="chtgtl"> Th·ªùi gian tr·∫£ l·ªùi c√¢u h·ªèi</label><br>
            <label id="numbertgtlch" style="display:none;">Th·ªùi gian tr·∫£ l·ªùi: <input type="number" id="thoigiantraloi" value="15" min="6" max="30" style="width:50px"></label>
        </div>
    </div>
  </div>
	
</div>	
	
</div>
	

<div id="pond-container">
<div id="vachxuatphat" class="xuatphat"></div>
	
<div id="bank"></div>
<div id="bo" class="bo"></div>	
<div id="startLine" class="start-line"></div>	
	<div id="pond"></div>
  <div id="countdown"></div>
<div id="vachvedich" class="vedich"></div>		
</div>
<div class="traloicauhoi">
	 <button id="traloi" class="btn-overlay" onclick="traloicauhois()"><img src="button_tl.png" alt=""><span>Tr·∫£ l·ªùi c√¢u h·ªèi</span></button>
	</div>
<div id="result"></div>
	
		
	
<audio id="winSound" src="win.mp3"></audio>
<audio id="hover" src="hover.mp3"></audio>
<audio id="click" src="bling.mp3"></audio>
<audio id="dung" src="dung.mp3"></audio>
<audio id="sai" src="sai.mp3"></audio>
<audio id="nhacnen" src="nhacnen.mp3"></audio>
	
<script>	
const pond = document.getElementById('pond');
const setupBtn = document.getElementById('setupBtn');
const startBtn = document.getElementById('startBtn');
const countdown = document.getElementById('countdown');
const result = document.getElementById('result');
const winSound = document.getElementById('winSound');
const hover = document.getElementById('hover');
const click = document.getElementById('click');	
const dung = document.getElementById('dung');		
const sai = document.getElementById('sai');		
const nhacnen = document.getElementById('nhacnen');		
	
let ducks = [], raceStarted=false, winner=null, readyToRun=false;
let cameraX=0;
const FPS = 60;
let treesCreated = false;	
const vedich = document.getElementById("vachvedich");
 vedich.classList.add("hidden");	
function lerp(a,b,t){return a+(b-a)*t;}

// Canvas n∆∞·ªõc
const canvas=document.createElement('canvas');
pond.appendChild(canvas);
const ctx=canvas.getContext('2d');
canvas.style.position="absolute"; canvas.style.top=0; canvas.style.left=0; canvas.style.zIndex=0;canvas.style.pointerEvents = "none";

//Doamm mpi
const menuBtn = document.getElementById("menuBtn");
const winnerMenu = document.getElementById("winnerMenu");
const closeMenu = document.getElementById("closeMenu");
const resetGame = document.getElementById("resetGame");
const winnerList = document.getElementById("winnerList");
const excludeCheckbox = document.getElementById("excludeWinners");	
const hoatanh = document.getElementById("hoatanh");
	
let games="duavit";
let trees = [];
let hoas=[];
let das=[];	
let scores = {}; // L∆∞u ƒëi·ªÉm { "T√™n": ƒëi·ªÉm }	
const TREE_COUNT = 12;
const HOA_COUNT =22;
const DA_COUNT = 26;	
const POND_LENGTH = 13000;
const MAX_DISTANCE = 11000; // kho·∫£ng c√°ch t·ªëi ƒëa	
let winners = [];
let excludeWinnersNextRound = false;
let  raceDuration = 5;
let raceTimeLeft = raceDuration;
let vit=true;
let thuyen=false;	
let bird =false;
let dongvat =false;	
// ‚öôÔ∏è C·∫•u h√¨nh
let traloicauhoi=false;	
let questionType = "tuluan"; // "tuluan" ho·∫∑c "tracnghiem"
let loaiKhiSai = false;
let soCauToiDa = 3;	
let amnhac=false;
let isPlaying = false;	
let questionPool=[];
let questionbandau=[];
let questions=[];	
let lopname;	
let students=[];
let names=[];	
let questionsTracNghiem =[];
let questionsTuLuan=[];
//ƒê·∫øm ng∆∞∆°cj
let questionTimer; // bi·∫øn l∆∞u interval
let questionTimeLeft = 10; // 10 gi√¢y, c√≥ th·ªÉ thay ƒë·ªïi
	
	
// üß† --- T·∫¢I D·ªÆ LI·ªÜU T·ª™ localStorage ---
// Danh s√°ch nh·∫≠p t·ª´ textarea

function playSound(sound,amnhac){ 
  sound.currentTime = 0; 
	if(amnhac==true)
  sound.play(); 
 	
}
function stopSound(sound){ 
  sound.pause(); 
}
	
nhacnen.loop = true;
nhacnen.volume = 0.5;

const toggleMusicBtn = document.getElementById("toggleMusic");
const volumeSlider = document.getElementById("volumeSlider");
// üéµ B·∫≠t/t·∫Øt nh·∫°c
toggleMusicBtn.addEventListener("click", () => {
  if (isPlaying) {
    nhacnen.pause();
	amnhac=false;  
    toggleMusicBtn.textContent = "üîä B·∫≠t nh·∫°c";
  } else {
    nhacnen.play();
	amnhac=true;  
    toggleMusicBtn.textContent = "‚è∏ T·∫°m d·ª´ng";
  }
  isPlaying = !isPlaying;
});

// üéö Ch·ªânh √¢m l∆∞·ª£ng
volumeSlider.addEventListener("input", (e) => {
  nhacnen.volume = e.target.value;
});



// üß† --- T·∫¢I D·ªÆ LI·ªÜU T·ª™ localStorage ---
const thoigianduaInput = document.getElementById("thoigiandua");
function loadWinnersData() {
  // L·∫•y danh s√°ch ng∆∞·ªùi th·∫Øng
const stored = localStorage.getItem("winners"+games+lopname);
 if (stored) {
    winners = JSON.parse(stored);
  }
 const storedScores = localStorage.getItem("scores" + games + lopname);
if (storedScores) {
  scores = JSON.parse(storedScores);
} else {
  scores = {};
}
  // L·∫•y tr·∫°ng th√°i lo·∫°i kh·ªèi v√≤ng sau
  const exclude = localStorage.getItem("excludeWinnersNextRound"+games+lopname);
  excludeWinnersNextRound = exclude === "true";

  // G√°n tr·∫°ng th√°i cho checkbox n·∫øu t·ªìn t·∫°i
  if (excludeCheckbox) {
    excludeCheckbox.checked = excludeWinnersNextRound;

    // üîÅ Khi ng∆∞·ªùi d√πng tick / b·ªè tick ‚Üí l∆∞u l·∫°i
    excludeCheckbox.addEventListener("change", () => {
      excludeWinnersNextRound = excludeCheckbox.checked;
      localStorage.setItem(
        "excludeWinnersNextRound"+games+lopname,
        excludeWinnersNextRound
      );
    });
  }

  // C·∫≠p nh·∫≠t danh s√°ch hi·ªÉn th·ªã ng∆∞·ªùi th·∫Øng
  updateWinnerList();
}
let hoatanhcao=false;	
hoatanh.addEventListener("change", () => {
      hoatanhcao = hoatanh.checked;
    });	
	
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}
  
// L·∫•y ng·∫´u nhi√™n c√¢u h·ªèi v√† tr·ªôn opts
function getRandomQuestions(count) {
  if (questionPool.length < count) {
    questionPool = [...allQuestions];
  }

  // X√°o tr·ªôn pool
  shuffleArray(questionPool);

  const selected = questionPool.slice(0, count);
  questionPool.splice(0, count); // lo·∫°i b·ªè c√¢u ƒë√£ l·∫•y

  // Tr·ªôn opts v√† c·∫≠p nh·∫≠t answer cho t·ª´ng c√¢u
  selected.forEach(q => {
    const correctAnswer = q.opts[q.answer]; // l∆∞u ƒë√°p √°n ƒë√∫ng
    shuffleArray(q.opts);                   // tr·ªôn c√°c l·ª±a ch·ªçn
    q.answer = q.opts.indexOf(correctAnswer); // c·∫≠p nh·∫≠t v·ªã tr√≠ ƒë√°p √°n ƒë√∫ng
  });

  return selected;
}


const data = {
    "tenlop": "L·ªõp 6E",
    "students": ["Nguy·ªÖn Tr∆∞·ªùng An", "L√™ Nh·∫≠t Anh", "Nguy·ªÖn L√™ Ho√†i Anh", "V≈© Thi√™n √Çn", "Nguy·ªÖn BƒÉng BƒÉng", "V≈© Qu·ª≥nh Chi", "Nguy·ªÖn Qu·ª≥nh Chi", "Nguy·ªÖn Nh√¢n Chinh", "Nguy·ªÖn Tr·ªçng ƒê·∫°t", "Nguy·ªÖn Duy ƒê√¥ng", "Nguy·ªÖn Minh ƒê·ª©c", "L√™ Ti·∫øn D≈©ng", "Tr·∫ßn Th·ªã Thu H√†", "ƒê·∫∑ng An Khang", "V≈© T·ª≠ Kh√°nh", "B√πi ƒê√¨nh T√πng L√¢m", "Tr·∫ßn B·∫£o L√¢m", "Nguy·ªÖn Kh√°nh Linh", "Nguy·ªÖn V≈© Minh", "Nguy·ªÖn Tu·ªá Minh", "V≈© Duy Nam", "Ng. Th·ªã Kim Ng√¢n", "Ho√†ng Tr·ªçng Nghƒ©a", "Nguy·ªÖn Th·ªã Th·∫£o Nguy√™n", "Nguy·ªÖn Tu·ªá Nhi", "Nguy·ªÖn Qu·ª≥nh Ph∆∞∆°ng", "Nguy·ªÖn Nh∆∞ Qu·ª≥nh", "V∆∞∆°ng BƒÉng T√¢m", "Nguy·ªÖn Minh T√πng", "Nguy·ªÖn Th·∫£o V√¢n", "Nguy·ªÖn Nh·∫≠t Vy", "Tr·∫ßn H√† Vy"],
    "questions": [
        { "q": "T·ª´ n√†o sau ƒë√¢y l√† t·ª´ l√°y ho√†n to√†n?", "opts": ["Xanh xao", "Xinh x·∫Øn", "M·∫∑t m≈©i", "ThƒÉm th·∫≥m"], "answer": 3 },
        { "q": "Trong c√¢u 'Em l√†m b√†i t·∫≠p v·ªÅ nh√†.', b·ªô ph·∫≠n n√†o l√† ch·ªß ng·ªØ?", "opts": ["Em", "l√†m b√†i t·∫≠p", "v·ªÅ nh√†", "b√†i t·∫≠p"], "answer": 0 },
        { "q": "Bi·ªán ph√°p tu t·ª´ n√†o ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c√¢u 'M·∫∑t tr·ªùi l√† l√≤ng ƒë·ªè qu·∫£ tr·ª©ng kh·ªïng l·ªì'?", "opts": ["So s√°nh", "Nh√¢n h√≥a", "·∫®n d·ª•", "Ho√°n d·ª•"], "answer": 0 },
        { "q": "T·ª´ n√†o l√† t√≠nh t·ª´ ch·ªâ t√≠nh c√°ch?", "opts": ["C√°i b√†n", "Vui v·∫ª", "Nh·∫£y", "Cao"], "answer": 1 },
        { "q": "Th√†nh ph·∫ßn n√†o tr·∫£ l·ªùi cho c√¢u h·ªèi 'Khi n√†o?' trong c√¢u 'H√¥m qua, em ƒë∆∞·ª£c ƒëi·ªÉm 10.'", "opts": ["Em", "ƒë∆∞·ª£c ƒëi·ªÉm 10", "H√¥m qua", "ƒëi·ªÉm 10"], "answer": 2 },
        { "q": "T·ª´ n√†o l√† t·ª´ l√°y b·ªô ph·∫≠n?", "opts": ["L·∫∑ng l·∫Ω", "Xinh x·∫Øn", "ChƒÉm ch·ªâ", "Lung linh"], "answer": 1 },
        { "q": "T·ª´ n√†o l√† ƒë·∫°i t·ª´ nh√¢n x∆∞ng ng√¥i th·ª© nh·∫•t (s·ªë √≠t)?", "opts": ["B·∫°n", "H·ªç", "T√¥i", "C√°c b·∫°n"], "answer": 2 },
        { "q": "Bi·ªán ph√°p tu t·ª´ n√†o ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c√¢u 'Nh·ªØng ng√¥i sao th·ª©c ngo√†i kia'?", "opts": ["So s√°nh", "Nh√¢n h√≥a", "·∫®n d·ª•", "Ho√°n d·ª•"], "answer": 1 },
        { "q": "T·ª´ n√†o l√† t·ª´ ch·ªâ ƒë·∫∑c ƒëi·ªÉm c·ªßa s·ª± v·∫≠t?", "opts": ["Ng√¥i nh√†", "Ch·∫°y nh·∫£y", "Xanh bi·∫øc","ƒÇn u·ªëng"], "answer": 2 },
        { "q": "Trong c√¢u 'Ch√∫ b·ªô ƒë·ªôi d≈©ng c·∫£m b·∫£o v·ªá T·ªï qu·ªëc.', t·ª´ n√†o l√† danh t·ª´ ch·ªâ ng∆∞·ªùi?", "opts": ["d≈©ng c·∫£m", "b·∫£o v·ªá", "Ch√∫ b·ªô ƒë·ªôi", "T·ªï qu·ªëc"], "answer": 2 }
    ],
    "type": "questions"
};

// N·∫øu c√≥ tenlop + students
if (data.tenlop) {
     lopname = data.tenlop || "";
     students = data.students || [];
     names=[...students];
    document.getElementById("lopname").innerText = "L·ªõp: "+lopname.toUpperCase();
}

// N·∫øu c√≥ c√¢u h·ªèi
if (data.type === "questions" && data.questions) {

    questionPool = data.questions || [];
    const str = JSON.stringify(questionPool[0]);
    questionbandau=[...questionPool];
    if(str.includes("opts") && str.includes("answer")){
        questionsTracNghiem= getRandomQuestions();
        questionType="Tr·∫Øc nghi·ªám";
        document.getElementById("dangcauhoi").innerText="‚ùì D·∫°ng c√¢u h·ªèi tr·∫Øc nghi·ªám";
    }else{
        questionType="tuluan";
        document.getElementById("dangcauhoi").innerText="‚ùì D·∫°ng c√¢u h·ªèi t·ª± lu·∫≠n";
        questionsTuLuan=[...questionPool];
        shuffleArray(questionsTuLuan);

    }
    //questions=[...allQuestions];
}
loadWinnersData();
// üîÑ G·ªçi sau khi trang t·∫£i xong
//window.addEventListener("DOMContentLoaded", loadWinnersData());

// üíæ --- L∆ØU D·ªÆ LI·ªÜU V√ÄO localStorage ---
function saveWinnersData() {
  localStorage.setItem("winners"+games+lopname, JSON.stringify(winners));
  localStorage.setItem("excludeWinnersNextRound"+games+lopname, excludeWinnersNextRound);
  localStorage.setItem("scores" + games + lopname, JSON.stringify(scores));	
}

 const radios = document.querySelectorAll('input[name="race"]');

    // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi (change)
    radios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        if (e.target.checked) {
          if (e.target.value === "boat") {
			  thuyen=true;
			  vit=false;
			  bird=false;
			  dongvat=false;
          } 
		if (e.target.value === "duck") {
			  thuyen=false;
			  vit=true;
			bird=false;
			dongvat=false;
          }
		if (e.target.value === "bird") {
			  thuyen=false;
			  vit=false;
			  bird=true;
			dongvat=false;
          }
		if (e.target.value === "dongvat") {
			  dongvat=true;
			  thuyen=false;
			  vit=false;
			  bird=false;
          }	
        }
      });
    });	
// M·ªü / ƒë√≥ng menu
menuBtn.onclick = () => {
  winnerMenu.classList.toggle("show");
};
closeMenu.onclick = () => {
  winnerMenu.classList.remove("show");
};
winnerMenu.addEventListener("click", (e) => {
  if (e.target === winnerMenu) {
    winnerMenu.classList.remove("show");
  }
});	

// Khi tick checkbox -> c·∫≠p nh·∫≠t tr·∫°ng th√°i lo·∫°i & l∆∞u
excludeCheckbox.onchange = (e) => {
  excludeWinnersNextRound = e.target.checked;
  saveWinnersData();
};

// Khi c√≥ ng∆∞·ªùi th·∫Øng -> th√™m v√†o danh s√°ch
function addWinner(name) {
  if (!scores[name]) scores[name] = 0;
  scores[name] += 0; // ‚úÖ M·ªói l·∫ßn th·∫Øng +10 ƒëi·ªÉm	
  if (!winners.includes(name)) {
    winners.push(name);
    updateWinnerList();
    saveWinnersData();
  }
}

// C·∫≠p nh·∫≠t danh s√°ch hi·ªÉn th·ªã
function updateWinnerList() {
  winnerList.innerHTML = "";
  if (winners.length === 0) {
    winnerList.innerHTML = "<p>Ch∆∞a c√≥ ai th·∫Øng üê•</p>";
    return;
  }

  // S·∫Øp x·∫øp theo ƒëi·ªÉm cao nh·∫•t
  const sorted = [...winners].sort((a, b) => (scores[b] || 0) - (scores[a] || 0));

  sorted.forEach((name, index) => {
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.justifyContent = "space-between";
    div.style.alignItems = "center";
    div.style.marginBottom = "4px";
    div.style.padding = "4px 6px";
    div.style.borderBottom = "1px dashed #ccc";

    const nameSpan = document.createElement("span");
    nameSpan.textContent = `${index + 1}. üèÖ ${name} ‚Äî ${scores[name] || 0} ƒëi·ªÉm`;

    const removeBtn = document.createElement("button");
    removeBtn.textContent = "‚ùå";
    removeBtn.style.background = "#ff4d4d";
    removeBtn.style.border = "none";
    removeBtn.style.color = "white";
    removeBtn.style.borderRadius = "6px";
    removeBtn.style.cursor = "pointer";
    removeBtn.style.padding = "2px 6px";
    removeBtn.onclick = () => {
      winners.splice(winners.indexOf(name), 1);
      delete scores[name];
      saveWinnersData();
      updateWinnerList();
	  const slhs = document.getElementById("soluonghs");
	const temp= students.length- winners.length;
    slhs.textContent="S·ªë l∆∞·ª£ng h·ªçc sinh: "+ temp+"/"+students.length; 	
    };

    div.appendChild(nameSpan);
    div.appendChild(removeBtn);
    winnerList.appendChild(div);
  });
}




///////	
// üîÑ RESET GAME TO√ÄN B·ªò
resetGame.onclick = () => {
  if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën reset to√†n b·ªô game v·ªÅ ban ƒë·∫ßu kh√¥ng?")) {
    // X√≥a danh s√°ch th·∫Øng
    winners = [];
	names = [...students];  
	cauHienTai = 0;
    cauhoiketiep = 0;  
	 const slhs = document.getElementById("soluonghs");
    slhs.textContent="S·ªë l∆∞·ª£ng h·ªçc sinh: "+ students.length+"/"+students.length; 	  
    localStorage.removeItem("winners"+ games + lopname);
    localStorage.removeItem("excludeWinnersNextRound"+ games + lopname);
	scores = {};
    localStorage.removeItem("scores" + games + lopname);  
    excludeWinnersNextRound = false;
    excludeCheckbox.checked = true;
    updateWinnerList();
	            
	
	if(questionType=="tuluan"){
	    questionsTuLuan=[...questionbandau];
		shuffleArray(questionsTuLuan);
	}else{
		questionPool=[...questionbandau];
		questionsTracNghiem= getRandomQuestions();
	}				

    // X√≥a to√†n b·ªô v·ªãt, c√¢y, hoa, ƒë√°
    pond.querySelectorAll('.duck').forEach(e => e.remove());
    pond.querySelectorAll('.tree').forEach(e => e.remove());
    pond.querySelectorAll('.hoa').forEach(e => e.remove());
    pond.querySelectorAll('.da').forEach(e => e.remove());

    // ·∫®n v·∫°ch ƒë√≠ch, reset v·∫°ch xu·∫•t ph√°t
    vedich.classList.add("hidden");
    const xuatphat = document.getElementById("vachxuatphat");
    xuatphat.classList.remove("hidden");
    startLine.style.transform = "translateX(0px)";

    // Reset bi·∫øn game
    raceStarted = false;
    readyToRun = false;
    winner = null;
    raceTimeLeft = raceDuration;
    cameraX = 0;
    pond.style.transform = `translateX(0px)`;
    result.textContent = '';
    countdown.style.display = 'none';

    // Sinh l·∫°i c√¢y, hoa, ƒë√° m·∫∑c ƒë·ªãnh
    spawnInitialTrees();
    spawnInitialhoa();
    spawnInitialda();

    alert("Game ƒë√£ ƒë∆∞·ª£c reset v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu ‚úÖ");
  }
};

	
	

function resizeCanvas(){
  canvas.width = pond.clientWidth;
  canvas.height = pond.clientHeight;
}
window.addEventListener('resize',resizeCanvas); resizeCanvas();

let waveOffset=0;
function drawWater(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const grad=ctx.createLinearGradient(0,0,0,canvas.height);
  grad.addColorStop(0,'#5dade2'); grad.addColorStop(1,'#2874a6');
  ctx.fillStyle=grad; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.beginPath();
  ctx.moveTo(0,canvas.height/2);
  for(let x=0;x<canvas.width;x++){
    const y=Math.sin((x+waveOffset)*0.02)*5+canvas.height/2;
    ctx.lineTo(x,y);
  }
  ctx.lineTo(canvas.width,canvas.height);
  ctx.lineTo(0,canvas.height);
  ctx.closePath();
  ctx.fillStyle='rgba(255,255,255,0.1)'; ctx.fill();
  waveOffset+=2;
  requestAnimationFrame(drawWater);
}
//drawWater();


const treeImgs = [];
for (let i = 1; i <= 12; i++) {
	if(i<10){
  treeImgs.push(`cay/cay_0${i}.png`);
	}else{
		 treeImgs.push(`cay/cay_${i}.png`);
	}
}
const hoaImgs = [];
for (let i = 1; i <= 22; i++) {
  if(i<10){
  hoaImgs.push(`hoa/hoala_0${i}.png`);
	}else{
		 hoaImgs.push(`hoa/hoala_${i}.png`);
	}
}
const daImgs = [];
for (let i = 1; i <= 26; i++) {
 if(i<10){
  daImgs.push(`da/da_0${i}.png`);
	}else{
		 daImgs.push(`da/da_${i}.png`);
	}
}	


function spawnInitialTrees() {
   if (treesCreated) return;
  treesCreated = true;	
  trees.forEach(t => t.remove());
  trees = [];

  const bank = document.getElementById("bank"); // b·ªù
  for (let i = 0; i < TREE_COUNT; i++) {
    const tree = document.createElement("div");
    tree.className = "tree";

    const x = Math.random() * POND_LENGTH;
    const h = 120 + Math.random() * 70;

    tree.style.left = x + "px";
    tree.dataset.baseX = x;
    tree.style.height = h + "px";
    tree.style.width = h * 0.8 + "px";
    tree.style.bottom = "0px"; // g·ªëc ch·∫°m b·ªù
    tree.style.background = `url("${treeImgs[Math.floor(Math.random() * treeImgs.length)]}") no-repeat center / contain`;

    bank.appendChild(tree);
    trees.push(tree);
  }
  console.log("üå≥ Kh·ªüi t·∫°o c√¢y tr√™n b·ªù:", trees.length);
}
function spawnInitialhoa() {
  hoas.forEach(t => t.remove());
  hoas = [];

  const bank = document.getElementById("bank"); // b·ªù
  for (let i = 0; i < HOA_COUNT; i++) {
    const hoa = document.createElement("div");
    hoa.className = "tree";

    const x = Math.random() * POND_LENGTH;
    const h = 120 + Math.random() * 70;

    hoa.style.left = x + "px";
    hoa.dataset.baseX = x;
    hoa.style.height = h + "px";
    hoa.style.width = h * 0.8 + "px";
    hoa.style.bottom = "0px"; // g·ªëc ch·∫°m b·ªù
    hoa.style.background = `url("${hoaImgs[Math.floor(Math.random() * hoaImgs.length)]}") no-repeat center / contain`;

    bank.appendChild(hoa);
    hoas.push(hoa);
  }
}
function spawnInitialda() {
  das.forEach(t => t.remove());
  das = [];

  const bank = document.getElementById("bank"); // b·ªù
  for (let i = 0; i < DA_COUNT; i++) {
    const da = document.createElement("div");
    da.className = "tree";

    const x = Math.random() * POND_LENGTH;
    const h = 120 + Math.random() * 70;

    da.style.left = x + "px";
    da.dataset.baseX = x;
    da.style.height = h + "px";
    da.style.width = h * 0.8 + "px";
    da.style.bottom = "0px"; // g·ªëc ch·∫°m b·ªù
    da.style.background = `url("${daImgs[Math.floor(Math.random() * daImgs.length)]}") no-repeat center / contain`;

    bank.appendChild(da);
    das.push(da);
  }
}	

window.addEventListener('DOMContentLoaded', () => {
  nhacnen.play();	
  // N·∫øu b·∫°n ƒë√£ append canvas v√†o #pond tr∆∞·ªõc, h√£y ƒë·∫£m b·∫£o canvas kh√¥ng ch·∫∑n hi·ªÉn th·ªã:
  const canvas = document.querySelector('#pond canvas');
  if (canvas) {
    canvas.style.pointerEvents = "none";
    canvas.style.zIndex = "0";
  }
  const buttonhover = document.querySelectorAll("button"); // L·∫•y t·∫•t c·∫£ n√∫t tr√™n trang
  
  buttonhover.forEach(btn => {
    // Khi chu·ªôt di v√†o
	  /*
    btn.addEventListener("mouseenter", () => {
      playSound(hover, false); // G·ªçi h√†m ph√°t √¢m thanh
    });*/
	// Khi b·∫•m n√∫t
	  
    btn.addEventListener("click", () => {
      playSound(click, amnhac); // √¢m thanh khi click (v√≠ d·ª•: clickSound)
    }); 
  }); 
	
  if (!treesCreated) {
    spawnInitialTrees();
    spawnInitialhoa();
    spawnInitialda();
  }
	

});
// G·ªçi spawn khi load
//spawnInitialTrees();



// H√†m di chuy·ªÉn c√¢y theo camera (parallax)
function updateTrees(cameraX) {
  const parallaxSpeed = 0.5;
  trees.forEach(tree => {
    let baseX = parseFloat(tree.dataset.baseX);
    let screenX = baseX - cameraX * parallaxSpeed;
    tree.style.left = screenX + "px";

    if (screenX < -150) {
      baseX += POND_LENGTH;
      tree.dataset.baseX = baseX;
    }
  });
  hoas.forEach(hoa => {
    let baseX = parseFloat(hoa.dataset.baseX);
    let screenX = baseX - cameraX * parallaxSpeed;
    hoa.style.left = screenX + "px";

    if (screenX < -150) {
      baseX += POND_LENGTH;
      hoa.dataset.baseX = baseX;
    }
  });	
  das.forEach(da => {
    let baseX = parseFloat(da.dataset.baseX);
    let screenX = baseX - cameraX * parallaxSpeed;
    da.style.left = screenX + "px";

    if (screenX < -150) {
      baseX += POND_LENGTH;
      da.dataset.baseX = baseX;
    }
  });	
}
	
// Tr·∫£ v·ªÅ d·∫°ng r√∫t g·ªçn: "N T Anh" t·ª´ "Nguyen Thi Anh"
function shortenName(fullName) {
  if (!fullName || typeof fullName !== 'string') return '';

  // 1. X√≥a kho·∫£ng tr·∫Øng ƒë·∫ßu/cu·ªëi v√† nhi·ªÅu kho·∫£ng tr·∫Øng gi·ªØa
  const parts = fullName.trim().split(/\s+/).filter(Boolean);
  if (parts.length === 0) return '';

  // 2. N·∫øu ch·ªâ 1 ph·∫ßn th√¨ tr·∫£ v·ªÅ ch√≠nh n√≥ (ch·ªØ hoa ƒë·∫ßu)
  if (parts.length === 1) return capitalize(parts[0]);

  // 3. L·∫•y initial cho t·∫•t c·∫£ ph·∫ßn tr·ª´ ph·∫ßn cu·ªëi
  const initials = parts.slice(0, -1).map(p => p[0].toUpperCase());

  // 4. Ph·∫ßn cu·ªëi gi·ªØ nguy√™n nh∆∞ng chu·∫©n h√≥a hoa th∆∞·ªùng (vi·∫øt hoa ch·ªØ ƒë·∫ßu)
  const last = capitalize(parts[parts.length - 1]);

  // 5. N·ªëi: "N T Anh"
  return initials.join(' ') + ' ' + last;
}

// Helper: vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu, ph·∫ßn c√≤n l·∫°i vi·∫øt th∆∞·ªùng
function capitalize(s) {
  if (!s) return '';
  return s[0].toUpperCase() + s.slice(1).toLowerCase();
}
// Th√™m v√†o animateRace

	

function updateRaceTimer(){ document.getElementById('raceTimer').textContent=`‚è± ${Math.ceil(raceTimeLeft)}s`; }

// Khi b·∫•m setup v·ªãt, **kh√¥ng x√≥a c√¢y**
setupBtn.onclick = () => {
  raceStarted = false;
  readyToRun = false;
  winner = null;
  resetQuestion();	
  document.getElementById("traloi").style.display = "none";
  cameraX = 0;
  pond.style.transform = `translateX(0px)`;
  result.textContent = '';
  const thoigiandua = parseInt(thoigianduaInput.value) || 10; // chuy·ªÉn sang s·ªë, m·∫∑c ƒë·ªãnh 20		
  countdown.style.display = 'none';
  raceDuration = thoigiandua;
  raceTimeLeft = raceDuration;	
  // Ch·ªâ x√≥a v·ªãt c≈©, gi·ªØ c√¢y, hoa, ƒë√°
  pond.querySelectorAll('.duck').forEach(d => d.remove());

  startLine.style.transform = "translateX(0px)";
  document.getElementById("vachxuatphat").classList.remove("hidden");
  vedich.classList.add("hidden");

 const exclude = document.getElementById('excludeWinners').checked;
const winners = JSON.parse(localStorage.getItem('winners'+games+lopname) || '[]');

	
	 const slhs = document.getElementById("soluonghs");
	const temp= students.length- winners.length;
    slhs.textContent="S·ªë l∆∞·ª£ng h·ªçc sinh: "+ temp+"/"+students.length; 	
    // X√≥a to√†n b·ªô v·ªãt, c√¢y, hoa, ƒë√°
    pond.querySelectorAll('.duck').forEach(e => e.remove());
    pond.querySelectorAll('.tree').forEach(e => e.remove());
    pond.querySelectorAll('.hoa').forEach(e => e.remove());
    pond.querySelectorAll('.da').forEach(e => e.remove());

    spawnInitialTrees();
    spawnInitialhoa();
    spawnInitialda();
   startBtn.disabled=false;
// N·∫øu b·∫≠t ch·∫ø ƒë·ªô "b·ªè ng∆∞·ªùi th·∫Øng"
if (exclude) {
  names = names.filter(n => !winners.includes(n));
}

if (names.length === 0) {
  alert("Kh√¥ng c√≤n h·ªçc sinh n√†o ƒë·ªÉ ƒëua!");
  return;
}
    
  ducks = [];
  const pondHeight = pond.clientHeight;
  const bottomOffset = 180;
  const spacing = (pondHeight - bottomOffset) / (names.length + 1);
if(vit==true){
  if(!hoatanhcao){	
    document.body.style.background = 'url("songnuoc.gif") no-repeat center center';
document.body.style.backgroundSize = 'cover';
  }else{	
    document.body.style.background = 'url("songnuoc.gif") repeat-x center bottom';
    document.body.style.backgroundSize = 'cover';	
  }
  names.forEach((name, i) => {
	namerutgon=  shortenName(name);  
    const duck = document.createElement('div');
    duck.className = 'duck';
    duck.style.top = `${spacing * (i + 1)}px`;
    duck.innerHTML = `<img src="vit/vit (${(i % 60) + 1}).png"><div class="name">${namerutgon}</div>`;
    pond.appendChild(duck);

    ducks.push({
      element: duck,
      name,
      x: 0,
      yOffset: Math.random() * 10,
      baseSpeed: 2 + Math.random() * 1,
      boosting: false,
      active: true
    });
  });
}
if(thuyen==true){
 if(!hoatanhcao){	
 document.body.style.background = 'url("songnuoc.gif") no-repeat center center';
document.body.style.backgroundSize = 'cover';
 }else{
document.body.style.background = 'url("songnuoc.gif") repeat-x center bottom';
document.body.style.backgroundSize = 'cover';
 }
  names.forEach((name, i) => {
    const duck = document.createElement('div');
    duck.className = 'duck';
    duck.style.top = `${spacing * (i + 1)}px`;
	namerutgon=  shortenName(name);
	if(i<12){  
    duck.innerHTML = `<img src="thuyen/thuyen (${(i % 60) + 1}).gif"><div class="name">${namerutgon}</div>`;
    pond.appendChild(duck);
	}
	 if(i>=12){
	  let randomNumber = Math.floor(Math.random() * 12) + 1;	 
	  duck.innerHTML = `<img src="thuyen/thuyen (${randomNumber}).gif"><div class="name">${namerutgon}</div>`;
    pond.appendChild(duck); 
} 

    ducks.push({
      element: duck,
      name,
      x: 0,
      yOffset: Math.random() * 10,
      baseSpeed: 2 + Math.random() * 1,
      boosting: false,
      active: true
    });
  });	
}
  
if(bird==true){	
	 if(!hoatanhcao){
	document.body.style.background = 'url("sanbang.jpg") no-repeat center center';
document.body.style.backgroundSize = 'cover';
	 }else{
		document.body.style.background = 'url("sanbang.jpg") repeat-x center bottom';
document.body.style.backgroundSize = 'cover';
	 }
  names.forEach((name, i) => {
    const duck = document.createElement('div');
    duck.className = 'duck';
    duck.style.top = `${spacing * (i + 1)}px`;
	namerutgon=  shortenName(name);
	if(i<25){  
    duck.innerHTML = `<img src="chim/chimthuan (${(i) + 1}).gif"><div class="name">${namerutgon}</div>`;
	
    pond.appendChild(duck);
	}
	if(25<=i&&i<=36){  
      duck.innerHTML = `<img src="chim/chimnguoc (${(i) - 24}).gif" style="transform: scaleX(-1);"><div class="name">${namerutgon}</div>`;
    pond.appendChild(duck);
	}   
	 if(i>=37){
	  let randomNumber = Math.floor(Math.random() * 25) + 1;	 
	  duck.innerHTML = `<img src="chim/chimthuan (${randomNumber}).gif"><div class="name">${namerutgon}</div>`; 
    pond.appendChild(duck);	 
} 

    ducks.push({
      element: duck,
      name,
      x: 0,
      yOffset: Math.random() * 10,
      baseSpeed: 2 + Math.random() * 1,
      boosting: false,
      active: true
    });
  });	
}
  
if(dongvat==true){
 if(!hoatanhcao){	
  document.body.style.background = 'url("duongduaco.jpg") no-repeat center center';
document.body.style.backgroundSize = 'cover';
 }else{	
	document.body.style.background = 'url("duongduaco.jpg") repeat-x center bottom';
  document.body.style.backgroundSize = 'cover';
 }
  
  names.forEach((name, i) => {
    const duck = document.createElement('div');
    duck.className = 'duck';
    duck.style.top = `${spacing * (i + 1)}px`;
	namerutgon=  shortenName(name);
	if(i<19){  
    duck.innerHTML = `<img src="dongvat/dongvat (${(i) + 1}).gif"><div class="name">${namerutgon}</div>`;
	
    pond.appendChild(duck);
	}
	if(19<i&&i<=22){  
      duck.innerHTML = `<img src="dongvat/dongvat (${(i)}).gif" style="transform: scaleX(-1);"><div class="name">${namerutgon}</div>`;
    pond.appendChild(duck);
	}   
	 if(i>22){
	  let randomNumber = Math.floor(Math.random() * 17) + 1;	 
	  duck.innerHTML = `<img src="dongvat/dongvat (${randomNumber}).gif"><div class="name">${namerutgon}</div>`;
    pond.appendChild(duck);	 
} 

    ducks.push({
      element: duck,
      name,
      x: 0,
      yOffset: Math.random() * 10,
      baseSpeed: 2 + Math.random() * 1,
      boosting: false,
      active: true
    });
  });	
};
  startBtn.disabled = false;
};
		


startBtn.onclick = async () => {
  if (ducks.length === 0) return;


  result.textContent = '';
  startBtn.disabled = true;
  setupBtn.disabled = true;
  countdown.style.display = "block";

  for (let i = 3; i > 0; i--) {
    countdown.textContent = i;
    await new Promise(r => setTimeout(r, 1000));
  }

  countdown.textContent = "GO!";
  await new Promise(r => setTimeout(r, 700));
  countdown.style.display = "none";

  const xuatphat = document.getElementById("vachxuatphat");
  xuatphat.classList.add("hidden");

  readyToRun = true;
  raceStarted = true;
  animateRace();
};
	

// Hi·ªáu ·ª©ng
function createSplash(x, y) { for(let i=0;i<8;i++){const s=document.createElement("div"); s.className="splash"; s.style.left=x+(Math.random()*40-20)+"px"; s.style.top=y+(Math.random()*20-10)+"px"; pond.appendChild(s); setTimeout(()=>s.remove(),600); } }
function createConfetti(x, y) { for(let i=0;i<15;i++){const c=document.createElement("div"); c.className="confetti"; c.style.left=x+(Math.random()*60-30)+"px"; c.style.top=y+(Math.random()*20-10)+"px"; c.style.background=`hsl(${Math.random()*360},80%,60%)`; pond.appendChild(c); setTimeout(()=>c.remove(),1000); } }
function createWaterRing(x, y) { const ring = document.createElement("div"); ring.className = "water-ring"; ring.style.left = (x - 10) + "px"; ring.style.top = (y - 10) + "px"; pond.appendChild(ring); setTimeout(() => ring.remove(), 1500); }
	

function animateRace(){
  if(!raceStarted || !readyToRun) return;
  const delta = 1/FPS;
  raceTimeLeft -= delta;
  if(raceTimeLeft < 0) raceTimeLeft = 0;
  updateRaceTimer();

  // X√°c ƒë·ªãnh v·ªãt d·∫´n ƒë·∫ßu
  const leadDuck = ducks.reduce((a,b)=>a.x>b.x?a:b);

  ducks.forEach(d=>{
    // N·∫øu v·ªãt kh√¥ng active v√† kh√¥ng ph·∫£i d·∫´n ƒë·∫ßu -> b·ªè qua
    if(!d.active && d !== leadDuck) return;

    // Boosting
    if(!d.boosting && Math.random()<0.004){
      d.boosting=true;
      const oldSpeed=d.baseSpeed;
      const boost=2+Math.random()*3;
      const duration=800+Math.random()*1200;
      d.baseSpeed+=boost;
      setTimeout(()=>{d.baseSpeed=oldSpeed; d.boosting=false;},duration);
    }

    // Di chuy·ªÉn
    if(d === leadDuck){
      if(d.x < MAX_DISTANCE){
        d.x += d.baseSpeed + (Math.random()-0.5)*1.2;
      } else {
        d.active = false; // d·∫´n ƒë·∫ßu ƒë·∫°t MAX_DISTANCE -> d·ª´ng
      }
    } else if(raceTimeLeft <= 0){
      d.active = false; // c√°c v·ªãt kh√°c h·∫øt th·ªùi gian -> d·ª´ng
    } else {
      d.x += d.baseSpeed + (Math.random()-0.5)*1.2;
    }

    d.yOffset += 0.05;
    d.element.style.left = d.x + "px";
    d.element.style.transform = `translateY(${Math.sin(d.yOffset)*5}px)`;

    // Bong b√≥ng
    if(d.active && Math.random()<0.04 && pond.querySelectorAll(".bubble").length<60){
      const bubble=document.createElement("div");
      bubble.className="bubble";
      bubble.style.left=(d.x+40)+"px";
      bubble.style.top=(d.element.offsetTop+50)+"px";
      pond.appendChild(bubble);
      setTimeout(()=>bubble.remove(),2000);
    }
  });

  const pondWidth = pond.parentElement.clientWidth;
  let targetCameraX = 0;
  if(leadDuck.x > 150) targetCameraX = leadDuck.x - pondWidth/2 + 35;
  const lerpFactor = raceDuration - raceTimeLeft < 2 ? 0.02 : 0.08;
  cameraX = lerp(cameraX, targetCameraX, lerpFactor);
  pond.style.transform = `translateX(${-cameraX}px)`;

  // Di chuy·ªÉn c√¢y theo camera
  updateTrees(cameraX); 

  const startLine = document.getElementById("startLine");
  startLine.style.transform = `translateX(${-cameraX}px)`;  
  const movebo = document.getElementById("bo");
  movebo.style.transform = `translateX(${-cameraX}px)`;  
   const moveboco = document.getElementById("bank");
  moveboco.style.transform = `translateX(${-cameraX}px)`; 
	if(hoatanhcao){
  document.body.style.backgroundPosition = `${-cameraX}px`;
	}


	
  // Gi·ªØ nguy√™n kh·ªëi winner hi·ªán t·∫°i
  if(raceTimeLeft <=0 && !winner){
    winner=ducks.reduce((a,b)=>a.x>b.x?a:b);
    ducks.forEach(d=>{ if(d!==winner) d.active=false; });
    result.textContent=`üèÜ${winner.name.toUpperCase()}`;
    winner.element.classList.add("winner-glow");
    
    vedich.classList.remove("hidden");
    addWinner(winner.name);
	const slhs = document.getElementById("soluonghs");
	const temp= students.length- winners.length;
    slhs.textContent="S·ªë l∆∞·ª£ng h·ªçc sinh: "+ temp+"/"+students.length;  
	if(traloicauhoi==true){  
	    document.getElementById("traloi").style.display = "block";
	}
	scores[winner.name] = 0;  
	  if(amnhac)
		   winSound.play();
    const x = winner.x + 35;
    const y = winner.element.offsetTop + 40;
    createSplash(x, y); createConfetti(x, y-30); createWaterRing(x, y);
    let splashInterval = setInterval(()=>createSplash(x,y),600);
    let confettiInterval = setInterval(()=>createConfetti(x,y-30),1000);
    let ringInterval = setInterval(()=>createWaterRing(x,y),1200);
    setTimeout(()=>{clearInterval(splashInterval); clearInterval(confettiInterval); clearInterval(ringInterval);},5000);

    startBtn.disabled=true; setupBtn.disabled=false;
  }

  requestAnimationFrame(animateRace);
}
	
	
	
	
function traloicauhois() {
	askWinnerQuestion(winner.name);
    document.getElementById("traloi").style.display = "none";
}	
// ===================== üß† PH·∫¶N C√ÇU H·ªéI SAU KHI CHI·∫æN TH·∫ÆNG =====================



// üèÜ Giao di·ªán c·∫•u h√¨nh th√™m

/*
document.querySelectorAll('input[name="qType"]').forEach(r => {
  r.onchange = e => questionType = e.target.value;
});*/
document.getElementById("chkLoai").onchange = e => loaiKhiSai = e.target.checked;
document.getElementById("hstraloicauhoi").onchange = e => {
    traloicauhoi = e.target.checked;
    if(traloicauhoi){
		   document.getElementById("opcauhoi").style.display = "block";
	}else{
		document.getElementById("opcauhoi").style.display = "none";
	}
};	
let thoigiantlch=false;	
document.getElementById("chtgtl").onchange = e => {
    thoigiantlch  = e.target.checked;
    if(thoigiantlch){
		   
		   document.getElementById("numbertgtlch").style.display = "block";
		
	}else{
		document.getElementById("numbertgtlch").style.display = "none";
	}
};	
document.getElementById("numQ").onchange = e => soCauToiDa = parseInt(e.target.value);
document.getElementById("thoigiantraloi").onchange = e => questionTimeLeft = parseInt(e.target.value);

	
function startQuestionCountdown(seconds) {
    const countdownEl = document.getElementById("questionCountdown");
   // const answerBtn = document.getElementById("traloi");
   TimeLeft = seconds;

    countdownEl.textContent = "‚è±"+TimeLeft + "s";

    clearInterval(questionTimer); // n·∫øu ƒëang ch·∫°y th√¨ d·ª´ng
    questionTimer = setInterval(() => {
        TimeLeft--;
        countdownEl.textContent = "‚è±"+TimeLeft + "s";
        if (TimeLeft <= 0) {
            clearInterval(questionTimer);
            countdownEl.textContent = "H·∫øt gi·ªù!";
            //answerBtn.disabled = true; // v√¥ hi·ªáu h√≥a n√∫t
			if(loaiKhiSai){
				closeQuestion();
			}else{
				showNextQuestion(winner.name);
			}
        }
    }, 1000);
}	
	
// üß© H·ªôp hi·ªÉn th·ªã c√¢u h·ªèi khi c√≥ ng∆∞·ªùi th·∫Øng
const qArea = document.createElement("div");
qArea.id = "questionArea";
qArea.style.cssText = `
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  background:white; color:black; padding:20px; border-radius:15px;
  text-align:center; display:none; z-index:900; width:80vw;max-hight=90vh;
`;
document.body.appendChild(qArea);

let cauHienTai = 0;
let cauhoiketiep = 0;

// üì£ H√†m g·ªçi khi c√≥ ng∆∞·ªùi th·∫Øng
function askWinnerQuestion(name) {
  cauHienTai = 0;
  showNextQuestion(name);
}
function checkAnswer(chon, dung) {
  const buttons = qArea.querySelectorAll("button"); // L·∫•y t·∫•t c·∫£ n√∫t trong v√πng c√¢u h·ªèi
  buttons.forEach((btn, index) => {
    // Ch·ªâ highlight c√°c n√∫t A, B, C, D (lo·∫°i b·ªè n√∫t "B·ªè qua")
    if (btn.innerText.match(/^[A-D]\./)) {
      if (index === dung) {
        btn.style.backgroundColor = "lightgreen"; // ƒê√°p √°n ƒë√∫ng
      } else if (index === chon) {
        btn.style.backgroundColor = "lightcoral"; // ƒê√°p √°n sai ƒë√£ ch·ªçn
      } else {
        btn.style.opacity = "0.6";
      }
      btn.disabled = true; // Kh√¥ng cho b·∫•m l·∫°i
    }
  });
}
// üß† Hi·ªÉn th·ªã c√¢u h·ªèi k·∫ø ti·∫øp
function showNextQuestion(name) {
  if (cauHienTai >= soCauToiDa) {
    qArea.style.display = "block"; 
    qArea.innerHTML = `<h3>üéâS·ªë ƒëi·ªÉm ${name} : ${scores[name]} ƒëi·ªÉm</h3><button onclick="closeht()">ƒê√≥ng</button>`;
    return;
  }
  cauHienTai++;
  cauhoiketiep++;	

  if (questionType === "tuluan") {
	
    const q = questionsTuLuan[cauhoiketiep % questionsTuLuan.length];
    qArea.innerHTML = `
      <div id="questionCountdown"></div>
      <h3>C√¢u ${cauHienTai}: ${q.q}</h3>
      <button onclick="showAnswer('${q.answer}','${name}')">üëÄ Hi·ªán ƒë√°p √°n</button><br><br>
      <button onclick="closeQuestion()">B·ªè qua</button>
    `;
	  if(thoigiantlch)
	  startQuestionCountdown(questionTimeLeft);
  }
	
	else {
    const q = questionsTracNghiem[cauhoiketiep % questionsTracNghiem.length];
    qArea.innerHTML = `
       <div id="questionCountdown"></div>
      <h3>C√¢u ${cauHienTai}: ${q.q}</h3>
      ${q.opts.map((o, i) => `<button style="margin:5px" onclick="teacherCheck(${i},${q.answer},'${name}')">${String.fromCharCode(65 + i)}. ${o}</button>`).join("<br>")}
      <br><br><button class="btn_boqua" onclick="closeQuestion()">B·ªè qua</button>
    `;
		if(thoigiantlch)
	    startQuestionCountdown(questionTimeLeft);
  }

  qArea.style.display = "block";
}

// üë©‚Äçüè´ V·ªõi t·ª± lu·∫≠n: hi·ªán ƒë√°p √°n
function showAnswer(ans, name) {
      clearInterval(questionTimer); // n·∫øu ƒëang ch·∫°y th√¨ d·ª´ng
	
  qArea.innerHTML = `
    <h3>ƒê√°p √°n: ${ans}</h3>
    <button onclick="markAnswer(true,'${name}')">‚úÖ ƒê√∫ng</button>
    <button onclick="markAnswer(false,'${name}')">‚ùå Sai</button>
  `;
}

// üë©‚Äçüè´ V·ªõi tr·∫Øc nghi·ªám: gi√°o vi√™n ch·ªçn n√∫t
function teacherCheck(chon, dung, name) {
     clearInterval(questionTimer); // n·∫øu ƒëang ch·∫°y th√¨ d·ª´ng
	
  checkAnswer(chon, dung); // üëâ G·ªçi ƒë·ªÉ highlight ƒë√°p √°n	
  const correct = (chon === dung);
  setTimeout(() => {  // Ch·ªù 1 gi√¢y ƒë·ªÉ ng∆∞·ªùi xem th·∫•y highlight
    markAnswer(correct, name);
  }, 1000);	
}

// ‚úÖ Ghi ƒëi·ªÉm ho·∫∑c lo·∫°i h·ªçc sinh
function markAnswer(correct, name) {
      clearInterval(questionTimer); // n·∫øu ƒëang ch·∫°y th√¨ d·ª´ng
	
  if (correct) {
	playSound(dung,amnhac);  
    if (!scores[name]) scores[name] = 0;
    scores[name] += 10;
    //alert(`‚úÖ ${name} ƒë∆∞·ª£c c·ªông 10 ƒëi·ªÉm!`);
    saveWinnersData();
    updateWinnerList();
    showNextQuestion(name);
  } else {
		playSound(sai,amnhac);    
    //alert(`‚ùå ${name} tr·∫£ l·ªùi sai!`);
    if (loaiKhiSai) {
      alert(`üö´ ${name} b·ªã lo·∫°i kh·ªèi l∆∞·ª£t h·ªèi!`);
      closeQuestion();
    } else {
      showNextQuestion(name);
    }
  }
}
function resetQuestion() {
	  qArea.style.display = "none";
}
// üîí ƒê√≥ng h·ªôp c√¢u h·ªèi
function closeQuestion() {
  qArea.style.display = "none";
  clearInterval(questionTimer); // n·∫øu ƒëang ch·∫°y th√¨ d·ª´ng
  if (loaiKhiSai) {
	  qArea.style.display = "block"; 
      qArea.innerHTML = `<h3>üéâS·ªë ƒëi·ªÉm ${winner.name} : ${scores[winner.name]} ƒëi·ªÉm</h3><button onclick="closeht()">ƒê√≥ng</button>`;
    } else {
      showNextQuestion(winner.name);
    }	
}
function closeht() {
  qArea.style.display = "none";
}
	

</script>
</body>
</html>
